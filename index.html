<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>CINEMATE ¬∑ –ò–¥–µ–∞–ª—å–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è</title>
    <style>
        /* –°—Ç–∏–ª–∏ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π (–∫–∞–∫ –≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏) */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0b0e14; 
            color: white; 
            min-height: 100vh;
        }
        .container { max-width: 1400px; margin: 0 auto; padding: 16px; }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 10px 0;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .logo {
            font-size: 24px;
            font-weight: 600;
        }
        
        .logo i {
            color: #5f7cff;
            margin-right: 8px;
        }
        
        .connection-status {
            background: #1a1f2b;
            padding: 8px 16px;
            border-radius: 50px;
            font-size: 14px;
            border: 1px solid #333;
        }
        
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-connected { background: #4caf50; box-shadow: 0 0 10px #4caf50; }
        .status-disconnected { background: #ff6b6b; }
        .status-connecting { background: #ffaa00; }
        
        .guide {
            background: #1a1f2b;
            border-radius: 16px;
            padding: 15px 20px;
            margin-bottom: 20px;
            border-left: 4px solid #5f7cff;
        }
        
        .guide h4 {
            color: #5f7cff;
            margin-bottom: 10px;
        }
        
        .guide ol {
            margin-left: 20px;
            color: #aaa;
            line-height: 1.6;
        }
        
        .room-section {
            background: #1a1f2b;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #333;
        }
        
        .room-title {
            font-size: 18px;
            margin-bottom: 15px;
            color: #5f7cff;
        }
        
        .room-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .room-btn {
            background: #5f7cff;
            border: none;
            color: white;
            padding: 12px 25px;
            border-radius: 50px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
            font-size: 14px;
        }
        
        .room-btn.secondary {
            background: #2a2f3a;
        }
        
        .room-btn.danger {
            background: #ff6b6b;
        }
        
        .room-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            filter: brightness(1.1);
        }
        
        .room-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .room-input {
            background: #0b0e14;
            border: 1px solid #333;
            color: white;
            padding: 12px 15px;
            border-radius: 50px;
            width: 250px;
            outline: none;
        }
        
        .room-input:focus {
            border-color: #5f7cff;
        }
        
        .room-info {
            margin-top: 15px;
            padding: 15px;
            background: #0b0e14;
            border-radius: 12px;
            border: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .room-id-box {
            display: flex;
            align-items: center;
            gap: 10px;
            background: #1a1f2b;
            padding: 8px 16px;
            border-radius: 50px;
        }
        
        .room-id {
            font-family: monospace;
            font-size: 18px;
            color: #5f7cff;
            font-weight: 600;
        }
        
        .copy-btn {
            background: none;
            border: none;
            color: #888;
            cursor: pointer;
            font-size: 16px;
        }
        
        .copy-btn:hover {
            color: #5f7cff;
        }
        
        .users-list {
            display: flex;
            gap: 10px;
        }
        
        .user-badge {
            background: #2a2f3a;
            padding: 5px 12px;
            border-radius: 50px;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .user-badge.host {
            background: #5f7cff;
        }
        
        .user-badge i {
            font-size: 12px;
        }
        
        .url-section {
            margin-bottom: 20px;
        }
        
        .url-box {
            display: flex;
            gap: 10px;
            background: #1a1f2b;
            border-radius: 50px;
            padding: 5px;
            border: 1px solid #333;
        }
        
        .url-box input {
            flex: 1;
            background: transparent;
            border: none;
            padding: 15px 20px;
            color: white;
            font-size: 16px;
            outline: none;
        }
        
        .url-box button {
            background: #5f7cff;
            border: none;
            border-radius: 50px;
            padding: 0 30px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
            white-space: nowrap;
        }
        
        .url-box button:hover {
            background: #738dff;
        }
        
        .supported-sites {
            display: flex;
            gap: 15px;
            margin: 10px 0 0 15px;
            color: #888;
            font-size: 13px;
            flex-wrap: wrap;
        }
        
        .supported-sites span i {
            margin-right: 5px;
        }
        
        .supported-sites .vk { color: #4a76a8; }
        .supported-sites .rutube { color: #7cd3ff; }
        .supported-sites .ok { color: #ee8208; }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 320px;
            gap: 20px;
            height: calc(100vh - 300px);
            min-height: 500px;
        }
        
        .player-container {
            background: #000;
            border-radius: 16px;
            overflow: hidden;
            position: relative;
            border: 1px solid #333;
            display: flex;
            flex-direction: column;
        }
        
        .player-header {
            padding: 16px;
            background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            z-index: 10;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .player-header h3 {
            font-size: 16px;
            max-width: 70%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: white;
        }
        
        .player-wrapper {
            flex: 1;
            background: #000;
            position: relative;
        }
        
        #videoPlayer {
            width: 100%;
            height: 100%;
            border: none;
        }
        
        .native-video-player {
            width: 100%;
            height: 100%;
            display: none;
        }
        
        .native-video-player video {
            width: 100%;
            height: 100%;
            background: #000;
        }
        
        .player-controls-overlay {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            justify-content: center;
            z-index: 20;
            pointer-events: none;
            flex-wrap: wrap;
        }
        
        .player-controls-overlay button {
            pointer-events: auto;
        }
        
        .control-btn {
            background: rgba(95, 124, 255, 0.9);
            border: none;
            color: white;
            padding: 12px 25px;
            border-radius: 50px;
            font-weight: 600;
            cursor: pointer;
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            gap: 8px;
            transition: 0.2s;
        }
        
        .control-btn:hover {
            background: #5f7cff;
            transform: scale(1.05);
        }
        
        .control-btn.secondary {
            background: rgba(42, 47, 58, 0.9);
        }
        
        .sync-status {
            position: absolute;
            top: 70px;
            right: 20px;
            background: rgba(76, 175, 80, 0.9);
            color: white;
            padding: 8px 16px;
            border-radius: 50px;
            font-size: 13px;
            z-index: 30;
            display: none;
            align-items: center;
            gap: 8px;
        }
        
        .chat-container {
            background: #1a1f2b;
            border-radius: 16px;
            border: 1px solid #333;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .chat-header {
            padding: 15px;
            border-bottom: 1px solid #333;
            font-weight: 600;
            color: #5f7cff;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .online-count {
            background: #2a2f3a;
            padding: 3px 10px;
            border-radius: 50px;
            font-size: 12px;
            color: #aaa;
        }
        
        .chat-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .message {
            padding: 8px 12px;
            border-radius: 12px;
            max-width: 85%;
            word-wrap: break-word;
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .message.own {
            background: #5f7cff;
            align-self: flex-end;
        }
        
        .message.other {
            background: #2a2f3a;
            align-self: flex-start;
        }
        
        .message.system {
            background: #333;
            align-self: center;
            max-width: 90%;
            text-align: center;
            font-style: italic;
            opacity: 0.8;
            font-size: 12px;
        }
        
        .message .sender {
            font-size: 12px;
            opacity: 0.7;
            margin-bottom: 4px;
        }
        
        .message .text {
            font-size: 14px;
            line-height: 1.4;
        }
        
        .message .time {
            font-size: 10px;
            opacity: 0.5;
            text-align: right;
            margin-top: 4px;
        }
        
        .chat-input-area {
            padding: 15px;
            border-top: 1px solid #333;
            display: flex;
            gap: 10px;
        }
        
        .chat-input {
            flex: 1;
            background: #0b0e14;
            border: 1px solid #333;
            color: white;
            padding: 12px;
            border-radius: 25px;
            outline: none;
        }
        
        .chat-input:focus {
            border-color: #5f7cff;
        }
        
        .chat-send-btn {
            background: #5f7cff;
            border: none;
            color: white;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            cursor: pointer;
            transition: 0.2s;
        }
        
        .chat-send-btn:hover:not(:disabled) {
            background: #738dff;
            transform: scale(1.1);
        }
        
        .chat-send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .typing-indicator {
            color: #888;
            font-size: 12px;
            padding: 5px 15px;
            font-style: italic;
        }
        
        .sync-progress {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 3px;
            background: #5f7cff;
            width: 0%;
            transition: width 0.3s;
        }
        
        @media (max-width: 900px) {
            .main-content {
                grid-template-columns: 1fr;
                height: auto;
            }
            
            .player-container {
                height: 50vh;
            }
            
            .chat-container {
                height: 400px;
            }
        }
        
        @media (max-width: 600px) {
            .url-box {
                flex-direction: column;
                border-radius: 24px;
            }
            
            .url-box button {
                padding: 12px;
                margin: 0 5px 5px 5px;
            }
            
            .room-controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .room-input {
                width: 100%;
            }
            
            .room-info {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">
                <i class="fas fa-film"></i> CINEMATE
            </div>
            <div class="connection-status" id="connectionStatus">
                <span class="status-indicator status-disconnected" id="statusIndicator"></span>
                <span id="statusText">–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —Å–µ—Ä–≤–µ—Ä—É</span>
            </div>
        </div>
        
        <div class="guide">
            <h4><i class="fas fa-info-circle"></i> –ö–∞–∫ —Å–º–æ—Ç—Ä–µ—Ç—å –≤–º–µ—Å—Ç–µ:</h4>
            <ol>
                <li><strong>–°–æ–∑–¥–∞—Ç–µ–ª—å</strong> –Ω–∞–∂–∏–º–∞–µ—Ç "–°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É" ‚Üí –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç ID –ø–æ–¥—Ä—É–≥–µ</li>
                <li><strong>–°–æ–∑–¥–∞—Ç–µ–ª—å</strong> –≤—Å—Ç–∞–≤–ª—è–µ—Ç —Å—Å—ã–ª–∫—É –Ω–∞ –≤–∏–¥–µ–æ ‚Üí –Ω–∞–∂–∏–º–∞–µ—Ç "–ó–∞–≥—Ä—É–∑–∏—Ç—å"</li>
                <li><strong>–ü–æ–¥—Ä—É–≥–∞</strong> –≤–≤–æ–¥–∏—Ç ID –∫–æ–º–Ω–∞—Ç—ã ‚Üí –Ω–∞–∂–∏–º–∞–µ—Ç "–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è"</li>
                <li>–û–±–∞ –º–æ–≥—É—Ç —É–ø—Ä–∞–≤–ª—è—Ç—å –≤–∏–¥–µ–æ - –≤—Å—ë —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</li>
                <li>–û–±—â–∞–π—Ç–µ—Å—å –≤ —á–∞—Ç–µ –≤–æ –≤—Ä–µ–º—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞!</li>
            </ol>
        </div>
        
        <div class="room-section">
            <div class="room-title">
                <i class="fas fa-users"></i> –ö–æ–º–Ω–∞—Ç–∞ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
            </div>
            <div class="room-controls">
                <button class="room-btn" id="createRoomBtn">
                    <i class="fas fa-plus-circle"></i> –°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É
                </button>
                <input type="text" class="room-input" id="roomIdInput" placeholder="–í–≤–µ–¥–∏—Ç–µ ID –∫–æ–º–Ω–∞—Ç—ã">
                <button class="room-btn secondary" id="joinRoomBtn">
                    <i class="fas fa-door-open"></i> –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è
                </button>
                <button class="room-btn danger" id="leaveRoomBtn" style="display: none;">
                    <i class="fas fa-sign-out-alt"></i> –ü–æ–∫–∏–Ω—É—Ç—å
                </button>
            </div>
            
            <div class="room-info" id="roomInfo" style="display: none;">
                <div class="room-id-box">
                    <i class="fas fa-door-open"></i>
                    <span class="room-id" id="currentRoomId"></span>
                    <button class="copy-btn" id="copyRoomIdBtn" title="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å ID">
                        <i class="far fa-copy"></i>
                    </button>
                </div>
                <div class="users-list" id="usersList">
                    <div class="user-badge host" id="hostBadge">
                        <i class="fas fa-crown"></i> <span id="hostName">–•–æ—Å—Ç</span>
                    </div>
                    <div class="user-badge" id="guestBadge" style="display: none;">
                        <i class="fas fa-user"></i> <span id="guestName">–ü–æ–¥—Ä—É–≥–∞</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="url-section">
            <div class="url-box">
                <input type="text" id="urlInput" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ –≤–∏–¥–µ–æ (VK, Rutube, OK, –ø—Ä—è–º—ã–µ —Å—Å—ã–ª–∫–∏)">
                <button id="loadUrlBtn"><i class="fas fa-play"></i> –ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
            </div>
            <div class="supported-sites">
                <span class="vk"><i class="fab fa-vk"></i> VK (–≤—Å–µ —Ñ–æ—Ä–º–∞—Ç—ã)</span>
                <span class="rutube"><i class="fas fa-play-circle"></i> Rutube (–ø–æ–ª–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è)</span>
                <span class="ok"><i class="fab fa-odnoklassniki"></i> OK</span>
            </div>
        </div>
        
        <div class="main-content">
            <div class="player-container" id="playerContainer">
                <div class="player-header">
                    <h3 id="currentVideoTitle">–í—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ –≤–∏–¥–µ–æ</h3>
                </div>
                <div class="player-wrapper" id="playerWrapper">
                    <iframe id="videoPlayer" frameborder="0" allowfullscreen allow="autoplay; encrypted-media; fullscreen"></iframe>
                    <div class="native-video-player" id="nativePlayer">
                        <video id="nativeVideo" controls></video>
                    </div>
                </div>
                
                <div class="player-controls-overlay">
                    <button class="control-btn" id="syncNowBtn" title="–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å–µ–π—á–∞—Å">
                        <i class="fas fa-sync-alt"></i> –°–∏–Ω—Ö—Ä.
                    </button>
                </div>
                
                <div class="sync-status" id="syncStatus">
                    <i class="fas fa-sync-alt fa-spin"></i> –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è...
                </div>
                <div class="sync-progress" id="syncProgress"></div>
            </div>
            
            <div class="chat-container">
                <div class="chat-header">
                    <span><i class="fas fa-comment"></i> –ß–∞—Ç</span>
                    <span class="online-count" id="onlineCount">0 –æ–Ω–ª–∞–π–Ω</span>
                </div>
                <div class="chat-messages" id="chatMessages"></div>
                <div class="typing-indicator" id="typingIndicator" style="display: none;"></div>
                <div class="chat-input-area">
                    <input type="text" class="chat-input" id="chatInput" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." disabled>
                    <button class="chat-send-btn" id="sendMessageBtn" disabled>
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

   <script>
    // ==================== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø FIREBASE ====================
    const firebaseConfig = {
        apiKey: "AIzaSyAOytQY6UErb0MAJI5WrBCf-jD9nq4XMcE",
        authDomain: "cinemateapp1.firebaseapp.com",
        databaseURL: "https://cinemateapp1-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "cinemateapp1",
        storageBucket: "cinemateapp1.firebasestorage.app",
        messagingSenderId: "916445746392",
        appId: "1:916445746392:web:4a9afd407a7ea9c60933ad"
    };

    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // ============== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ====================
    let currentUser = {
        id: 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5),
        name: '–ó—Ä–∏—Ç–µ–ª—å' + Math.floor(Math.random() * 1000),
        isHost: false,
        roomId: null
    };
    
    let roomRef = null;
    let videoStateRef = null;
    let chatRef = null;
    let videoElement = null;
    let currentVideoData = null;
    let isReceivingCommand = false; // –ü–†–û–°–¢–û–ô –§–õ–ê–ì
    
    // DOM —ç–ª–µ–º–µ–Ω—Ç—ã
    const createRoomBtn = document.getElementById('createRoomBtn');
    const joinRoomBtn = document.getElementById('joinRoomBtn');
    const leaveRoomBtn = document.getElementById('leaveRoomBtn');
    const roomIdInput = document.getElementById('roomIdInput');
    const roomInfo = document.getElementById('roomInfo');
    const currentRoomIdSpan = document.getElementById('currentRoomId');
    const copyRoomIdBtn = document.getElementById('copyRoomIdBtn');
    const loadUrlBtn = document.getElementById('loadUrlBtn');
    const urlInput = document.getElementById('urlInput');
    const videoPlayer = document.getElementById('videoPlayer');
    const nativePlayer = document.getElementById('nativePlayer');
    const nativeVideo = document.getElementById('nativeVideo');
    const currentVideoTitle = document.getElementById('currentVideoTitle');
    const chatMessages = document.getElementById('chatMessages');
    const chatInput = document.getElementById('chatInput');
    const sendMessageBtn = document.getElementById('sendMessageBtn');
    const statusIndicator = document.getElementById('statusIndicator');
    const statusText = document.getElementById('statusText');

    // ==================== –ü–†–û–°–¢–´–ï –§–£–ù–ö–¶–ò–ò ====================
    function showStatus(connected) {
        if (connected) {
            statusIndicator.className = 'status-indicator status-connected';
            statusText.textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —Å–µ—Ä–≤–µ—Ä—É';
        } else {
            statusIndicator.className = 'status-indicator status-disconnected';
            statusText.textContent = '–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è';
        }
    }

    // ==================== –°–û–ó–î–ê–ù–ò–ï –ö–û–ú–ù–ê–¢–´ ====================
    function createRoom() {
        const roomId = Math.random().toString(36).substr(2, 6).toUpperCase();
        
        roomRef = database.ref(`rooms/${roomId}`);
        videoStateRef = database.ref(`rooms/${roomId}/video`);
        chatRef = database.ref(`rooms/${roomId}/messages`);
        
        roomRef.set({
            createdAt: firebase.database.ServerValue.TIMESTAMP,
            hostId: currentUser.id,
            users: {
                [currentUser.id]: { name: currentUser.name, joinedAt: Date.now(), isHost: true }
            },
            video: { url: '', title: '', isPlaying: false, currentTime: 0 }
        }).then(() => {
            currentUser.roomId = roomId;
            currentUser.isHost = true;
            
            currentRoomIdSpan.textContent = roomId;
            roomInfo.style.display = 'flex';
            createRoomBtn.disabled = true;
            joinRoomBtn.disabled = true;
            roomIdInput.disabled = true;
            leaveRoomBtn.style.display = 'inline-block';
            chatInput.disabled = false;
            sendMessageBtn.disabled = false;
            
            setupListeners();
            addMessage('–°–∏—Å—Ç–µ–º–∞', '‚úÖ –í—ã —Å–æ–∑–¥–∞–ª–∏ –∫–æ–º–Ω–∞—Ç—É', 'system');
        });
    }

    // ==================== –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï –ö –ö–û–ú–ù–ê–¢–ï ====================
    function joinRoom(roomId) {
        roomRef = database.ref(`rooms/${roomId}`);
        videoStateRef = database.ref(`rooms/${roomId}/video`);
        chatRef = database.ref(`rooms/${roomId}/messages`);
        
        roomRef.once('value').then((snapshot) => {
            if (snapshot.exists()) {
                roomRef.child('users').child(currentUser.id).set({
                    name: currentUser.name,
                    joinedAt: Date.now(),
                    isHost: false
                }).then(() => {
                    currentUser.roomId = roomId;
                    currentUser.isHost = false;
                    
                    currentRoomIdSpan.textContent = roomId;
                    roomInfo.style.display = 'flex';
                    createRoomBtn.disabled = true;
                    joinRoomBtn.disabled = true;
                    roomIdInput.disabled = true;
                    leaveRoomBtn.style.display = 'inline-block';
                    chatInput.disabled = false;
                    sendMessageBtn.disabled = false;
                    
                    setupListeners();
                    addMessage('–°–∏—Å—Ç–µ–º–∞', '‚úÖ –í—ã –ø–æ–¥–∫–ª—é—á–∏–ª–∏—Å—å –∫ –∫–æ–º–Ω–∞—Ç–µ', 'system');
                });
            } else {
                alert('–ö–æ–º–Ω–∞—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
            }
        });
    }

    // ==================== –°–õ–£–®–ê–¢–ï–õ–ò ====================
    function setupListeners() {
        // –°–ª—É—à–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤–∏–¥–µ–æ - –ü–†–û–°–¢–û–ô –ò –ü–û–ù–Ø–¢–ù–´–ô
        videoStateRef.on('value', (snapshot) => {
            const data = snapshot.val();
            if (!data || !videoElement) return;
            
            console.log('–ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ:', data);
            
            // –ï—Å–ª–∏ —ç—Ç–æ –º–æ—è –∫–æ–º–∞–Ω–¥–∞ - –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º
            if (data.updatedBy === currentUser.id) {
                console.log('–≠—Ç–æ –º–æ—è –∫–æ–º–∞–Ω–¥–∞, –∏–≥–Ω–æ—Ä–∏—Ä—É—é');
                return;
            }
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥, —á—Ç–æ –º—ã –ø–æ–ª—É—á–∞–µ–º –∫–æ–º–∞–Ω–¥—É
            isReceivingCommand = true;
            
            // –ü—Ä–∏–º–µ–Ω—è–µ–º –∫–æ–º–∞–Ω–¥—É
            if (data.currentTime !== undefined) {
                videoElement.currentTime = data.currentTime;
            }
            
            if (data.command === 'play' || data.isPlaying === true) {
                videoElement.play();
            } else if (data.command === 'pause' || data.isPlaying === false) {
                videoElement.pause();
            }
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ —á–µ—Ä–µ–∑ –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É
            setTimeout(() => {
                isReceivingCommand = false;
            }, 100);
        });
        
        // –°–ª—É—à–∞–µ–º —á–∞—Ç
        chatRef.limitToLast(50).on('child_added', (snapshot) => {
            const msg = snapshot.val();
            if (msg && msg.userId !== currentUser.id) {
                displayMessage(msg);
            }
        });
        
        // –°–ª—É—à–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        roomRef.child('users').on('value', (snapshot) => {
            const users = snapshot.val() || {};
            document.getElementById('onlineCount').textContent = Object.keys(users).length + ' –æ–Ω–ª–∞–π–Ω';
        });
    }

    // ==================== –ù–ê–¢–ò–í–ù–´–ô –ü–õ–ï–ï–† ====================
    function setupNativePlayer() {
        if (!videoElement) return;
        
        // –£–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
        videoElement.removeEventListener('play', handlePlay);
        videoElement.removeEventListener('pause', handlePause);
        videoElement.removeEventListener('seeked', handleSeek);
        
        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ
        videoElement.addEventListener('play', handlePlay);
        videoElement.addEventListener('pause', handlePause);
        videoElement.addEventListener('seeked', handleSeek);
    }
    
    function handlePlay() {
        if (!currentUser.roomId || !videoStateRef) return;
        if (isReceivingCommand) return; // –ù–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º, –µ—Å–ª–∏ —ç—Ç–æ –∫–æ–º–∞–Ω–¥–∞ –∏–∑ Firebase
        
        console.log('–û—Ç–ø—Ä–∞–≤–ª—è—é play');
        videoStateRef.update({
            command: 'play',
            isPlaying: true,
            currentTime: videoElement.currentTime,
            updatedBy: currentUser.id,
            timestamp: firebase.database.ServerValue.TIMESTAMP
        });
    }
    
    function handlePause() {
        if (!currentUser.roomId || !videoStateRef) return;
        if (isReceivingCommand) return;
        
        console.log('–û—Ç–ø—Ä–∞–≤–ª—è—é pause');
        videoStateRef.update({
            command: 'pause',
            isPlaying: false,
            currentTime: videoElement.currentTime,
            updatedBy: currentUser.id,
            timestamp: firebase.database.ServerValue.TIMESTAMP
        });
    }
    
    function handleSeek() {
        if (!currentUser.roomId || !videoStateRef) return;
        if (isReceivingCommand) return;
        
        console.log('–û—Ç–ø—Ä–∞–≤–ª—è—é seek');
        videoStateRef.update({
            command: 'seek',
            currentTime: videoElement.currentTime,
            updatedBy: currentUser.id,
            timestamp: firebase.database.ServerValue.TIMESTAMP
        });
    }

    // ==================== –ó–ê–ì–†–£–ó–ö–ê –í–ò–î–ï–û ====================
    function loadVideo(url) {
        // –ü—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ mp4
        if (url.includes('.mp4') || url.includes('vk.com') || url.includes('rutube.ru')) {
            videoPlayer.style.display = 'none';
            nativePlayer.style.display = 'block';
            nativeVideo.src = url;
            nativeVideo.load();
            videoElement = nativeVideo;
            
            setupNativePlayer();
            
            currentVideoTitle.textContent = '–í–∏–¥–µ–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ';
            
            if (currentUser.roomId && videoStateRef) {
                videoStateRef.update({
                    url: url,
                    title: '–í–∏–¥–µ–æ',
                    isPlaying: false,
                    currentTime: 0,
                    updatedBy: currentUser.id
                });
            }
            
            addMessage('–°–∏—Å—Ç–µ–º–∞', 'üé¨ –í–∏–¥–µ–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ', 'system');
        } else {
            alert('–ü–æ–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä—è–º—ã–µ —Å—Å—ã–ª–∫–∏ –Ω–∞ –≤–∏–¥–µ–æ');
        }
    }

    // ==================== –ß–ê–¢ ====================
    function sendMessage(text) {
        if (!currentUser.roomId || !text.trim()) return;
        
        const message = {
            userId: currentUser.id,
            userName: currentUser.name,
            text: text.trim(),
            timestamp: firebase.database.ServerValue.TIMESTAMP
        };
        
        chatRef.push(message);
        displayMessage(message, true);
    }

    function displayMessage(msg, isOwn = false) {
        const div = document.createElement('div');
        div.className = `message ${isOwn ? 'own' : (msg.userId === 'system' ? 'system' : 'other')}`;
        
        const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        
        if (msg.userId === 'system') {
            div.innerHTML = `<div class="text">${msg.text}</div><div class="time">${time}</div>`;
        } else {
            div.innerHTML = `<div class="sender">${isOwn ? '–í—ã' : msg.userName}</div>
                            <div class="text">${msg.text}</div>
                            <div class="time">${time}</div>`;
        }
        
        chatMessages.appendChild(div);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function addMessage(sender, text) {
        displayMessage({ userId: 'system', userName: sender, text: text });
    }

    // ==================== –í–´–•–û–î ====================
    function leaveRoom() {
        if (currentUser.roomId) {
            database.ref(`rooms/${currentUser.roomId}/users/${currentUser.id}`).remove();
            if (currentUser.isHost) {
                database.ref(`rooms/${currentUser.roomId}`).remove();
            }
        }
        
        currentUser.roomId = null;
        currentUser.isHost = false;
        
        createRoomBtn.disabled = false;
        joinRoomBtn.disabled = false;
        roomIdInput.disabled = false;
        leaveRoomBtn.style.display = 'none';
        roomInfo.style.display = 'none';
        chatInput.disabled = true;
        sendMessageBtn.disabled = true;
        
        videoPlayer.src = '';
        nativeVideo.src = '';
        currentVideoTitle.textContent = '–í—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ –≤–∏–¥–µ–æ';
    }

    // ==================== –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –ö–ù–û–ü–û–ö ====================
    createRoomBtn.addEventListener('click', createRoom);
    
    joinRoomBtn.addEventListener('click', () => {
        const id = roomIdInput.value.trim().toUpperCase();
        if (id) joinRoom(id); else alert('–í–≤–µ–¥–∏—Ç–µ ID');
    });
    
    leaveRoomBtn.addEventListener('click', leaveRoom);
    
    copyRoomIdBtn.addEventListener('click', () => {
        navigator.clipboard.writeText(currentRoomIdSpan.textContent);
        alert('ID —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω');
    });
    
    loadUrlBtn.addEventListener('click', () => {
        const url = urlInput.value.trim();
        if (url) {
            if (!currentUser.roomId) {
                alert('–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ –∫–æ–º–Ω–∞—Ç—É');
                return;
            }
            loadVideo(url);
            urlInput.value = '';
        }
    });
    
    sendMessageBtn.addEventListener('click', () => {
        sendMessage(chatInput.value);
        chatInput.value = '';
    });
    
    chatInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            sendMessage(chatInput.value);
            chatInput.value = '';
        }
    });

    // –°—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
    database.ref('.info/connected').on('value', (s) => showStatus(s.val() === true));
    
    addMessage('–°–∏—Å—Ç–µ–º–∞', 'üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!');
</script>
</body>
</html>