<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>CINEMATE</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0b0e14; 
            color: white; 
            min-height: 100vh;
        }
        .container { max-width: 1400px; margin: 0 auto; padding: 16px; }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 10px 0;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .logo {
            font-size: 24px;
            font-weight: 600;
        }
        
        .logo i {
            color: #5f7cff;
            margin-right: 8px;
        }
        
        .connection-status {
            background: #1a1f2b;
            padding: 8px 16px;
            border-radius: 50px;
            font-size: 14px;
            border: 1px solid #333;
        }
        
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-connected { background: #4caf50; box-shadow: 0 0 10px #4caf50; }
        .status-disconnected { background: #ff6b6b; }
        .status-connecting { background: #ffaa00; }
        
        .guide {
            background: #1a1f2b;
            border-radius: 16px;
            padding: 15px 20px;
            margin-bottom: 20px;
            border-left: 4px solid #5f7cff;
        }
        
        .guide h4 {
            color: #5f7cff;
            margin-bottom: 10px;
        }
        
        .guide ol {
            margin-left: 20px;
            color: #aaa;
            line-height: 1.6;
        }
        
        .room-section {
            background: #1a1f2b;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #333;
        }
        
        .room-title {
            font-size: 18px;
            margin-bottom: 15px;
            color: #5f7cff;
        }
        
        .room-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .room-btn {
            background: #5f7cff;
            border: none;
            color: white;
            padding: 12px 25px;
            border-radius: 50px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
            font-size: 14px;
        }
        
        .room-btn.secondary {
            background: #2a2f3a;
        }
        
        .room-btn.danger {
            background: #ff6b6b;
        }
        
        .room-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            filter: brightness(1.1);
        }
        
        .room-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .room-input {
            background: #0b0e14;
            border: 1px solid #333;
            color: white;
            padding: 12px 15px;
            border-radius: 50px;
            outline: none;
        }
        
        .room-input:focus {
            border-color: #5f7cff;
        }
        
        .room-info {
            margin-top: 15px;
            padding: 15px;
            background: #0b0e14;
            border-radius: 12px;
            border: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .room-id-box {
            display: flex;
            align-items: center;
            gap: 10px;
            background: #1a1f2b;
            padding: 8px 16px;
            border-radius: 50px;
        }
        
        .room-id {
            font-family: monospace;
            font-size: 18px;
            color: #5f7cff;
            font-weight: 600;
        }
        
        .copy-btn {
            background: none;
            border: none;
            color: #888;
            cursor: pointer;
            font-size: 16px;
        }
        
        .copy-btn:hover {
            color: #5f7cff;
        }
        
        .users-list {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .user-badge {
            background: #2a2f3a;
            padding: 5px 12px;
            border-radius: 50px;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .user-badge.host {
            background: #5f7cff;
        }
        
        .user-badge i {
            font-size: 12px;
        }
        
        .url-section {
            margin-bottom: 20px;
        }
        
        .url-box {
            display: flex;
            gap: 10px;
            background: #1a1f2b;
            border-radius: 50px;
            padding: 5px;
            border: 1px solid #333;
        }
        
        .url-box input {
            flex: 1;
            background: transparent;
            border: none;
            padding: 15px 20px;
            color: white;
            font-size: 16px;
            outline: none;
        }
        
        .url-box button {
            background: #5f7cff;
            border: none;
            border-radius: 50px;
            padding: 0 30px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
            white-space: nowrap;
        }
        
        .url-box button:hover {
            background: #738dff;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 320px;
            gap: 20px;
            height: calc(100vh - 300px);
            min-height: 500px;
        }
        
        .player-container {
            background: #000;
            border-radius: 16px;
            overflow: hidden;
            position: relative;
            border: 1px solid #333;
            display: flex;
            flex-direction: column;
        }
        
        .player-header {
            padding: 16px;
            background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            z-index: 10;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .player-header h3 {
            font-size: 16px;
            max-width: 70%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: white;
        }
        
        .player-wrapper {
            flex: 1;
            background: #000;
            position: relative;
        }
        
        #videoPlayer {
            width: 100%;
            height: 100%;
            border: none;
            display: none;
        }
        
        .native-video {
            width: 100%;
            height: 100%;
            background: #000;
            display: none;
        }
        
        .player-controls-overlay {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            justify-content: center;
            z-index: 20;
            flex-wrap: wrap;
        }
        
        .control-btn {
            background: rgba(95, 124, 255, 0.9);
            border: none;
            color: white;
            padding: 12px 25px;
            border-radius: 50px;
            font-weight: 600;
            cursor: pointer;
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            gap: 8px;
            transition: 0.2s;
        }
        
        .control-btn:hover {
            background: #5f7cff;
        }
        
        .sync-status {
            position: absolute;
            top: 70px;
            right: 20px;
            background: rgba(76, 175, 80, 0.9);
            color: white;
            padding: 8px 16px;
            border-radius: 50px;
            font-size: 13px;
            z-index: 30;
            display: none;
            align-items: center;
            gap: 8px;
        }
        
        .chat-container {
            background: #1a1f2b;
            border-radius: 16px;
            border: 1px solid #333;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .chat-header {
            padding: 15px;
            border-bottom: 1px solid #333;
            font-weight: 600;
            color: #5f7cff;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .online-count {
            background: #2a2f3a;
            padding: 3px 10px;
            border-radius: 50px;
            font-size: 12px;
            color: #aaa;
        }
        
        .chat-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .message {
            padding: 8px 12px;
            border-radius: 12px;
            max-width: 85%;
            word-wrap: break-word;
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .message.own {
            background: #5f7cff;
            align-self: flex-end;
        }
        
        .message.other {
            background: #2a2f3a;
            align-self: flex-start;
        }
        
        .message.system {
            background: #333;
            align-self: center;
            max-width: 90%;
            text-align: center;
            font-style: italic;
            opacity: 0.8;
            font-size: 12px;
        }
        
        .message .sender {
            font-size: 12px;
            opacity: 0.7;
            margin-bottom: 4px;
        }
        
        .message .text {
            font-size: 14px;
            line-height: 1.4;
        }
        
        .message .time {
            font-size: 10px;
            opacity: 0.5;
            text-align: right;
            margin-top: 4px;
        }
        
        .chat-input-area {
            padding: 15px;
            border-top: 1px solid #333;
            display: flex;
            gap: 10px;
        }
        
        .chat-input {
            flex: 1;
            background: #0b0e14;
            border: 1px solid #333;
            color: white;
            padding: 12px;
            border-radius: 25px;
            outline: none;
        }
        
        .chat-input:focus {
            border-color: #5f7cff;
        }
        
        .chat-send-btn {
            background: #5f7cff;
            border: none;
            color: white;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            cursor: pointer;
            transition: 0.2s;
        }
        
        .chat-send-btn:hover:not(:disabled) {
            background: #738dff;
        }
        
        .chat-send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .role-badge {
            background: #5f7cff;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            margin-left: 5px;
        }
        
        @media (max-width: 900px) {
            .main-content {
                grid-template-columns: 1fr;
                height: auto;
            }
            
            .player-container {
                height: 50vh;
            }
            
            .chat-container {
                height: 400px;
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">
                <i class="fas fa-film"></i> CINEMATE 
            </div>
            <div class="connection-status" id="connectionStatus">
                <span class="status-indicator status-disconnected" id="statusIndicator"></span>
                <span id="statusText">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</span>
            </div>
        </div>
        
        <div class="guide">
            <h4><i class="fas fa-info-circle"></i> –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:</h4>
            <ol>
                <li><strong>–í–µ–¥—É—â–∏–π</strong> –Ω–∞–∂–∏–º–∞–µ—Ç "–°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É"</li>
                <li><strong>–í–µ–¥—É—â–∏–π</strong> –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç ID –ø–æ–¥—Ä—É–≥–µ (—Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–Ω–æ–ø–∫—É)</li>
                <li><strong>–ó—Ä–∏—Ç–µ–ª—å</strong> –≤—Å—Ç–∞–≤–ª—è–µ—Ç ID ‚Üí –Ω–∞–∂–∏–º–∞–µ—Ç "–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è"</li>
                <li><strong>–í–µ–¥—É—â–∏–π</strong> –∑–∞–≥—Ä—É–∂–∞–µ—Ç –≤–∏–¥–µ–æ (—Ç–æ–ª—å–∫–æ –≤–µ–¥—É—â–∏–π –º–æ–∂–µ—Ç)</li>
                <li>–í—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</li>
            </ol>
        </div>
        
        <div class="room-section">
            <div class="room-title">
                <i class="fas fa-users"></i> –ö–æ–º–Ω–∞—Ç–∞ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
            </div>
            <div class="room-controls">
                <button class="room-btn" id="createRoomBtn">
                    <i class="fas fa-plus-circle"></i> –°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É
                </button>
                <input type="text" class="room-input" id="roomIdInput" placeholder="–í–≤–µ–¥–∏—Ç–µ ID –∫–æ–º–Ω–∞—Ç—ã">
                <button class="room-btn secondary" id="joinRoomBtn">
                    <i class="fas fa-door-open"></i> –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è
                </button>
                <button class="room-btn danger" id="leaveRoomBtn" style="display: none;">
                    <i class="fas fa-sign-out-alt"></i> –ü–æ–∫–∏–Ω—É—Ç—å
                </button>
            </div>
            
            <div class="room-info" id="roomInfo" style="display: none;">
                <div class="room-id-box">
                    <i class="fas fa-door-open"></i>
                    <span class="room-id" id="currentRoomId"></span>
                    <button class="copy-btn" id="copyRoomIdBtn" title="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å ID">
                        <i class="far fa-copy"></i>
                    </button>
                </div>
                <div class="users-list" id="participantsList"></div>
            </div>
        </div>
        
        <div class="url-section">
            <div class="url-box">
                <input type="text" id="urlInput" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ –≤–∏–¥–µ–æ (MP4, Rutube, VK)">
                <button id="loadUrlBtn"><i class="fas fa-play"></i> –ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
            </div>
        </div>
        
        <div class="main-content">
            <div class="player-container" id="playerContainer">
                <div class="player-header">
                    <h3 id="currentVideoTitle">–í—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ –≤–∏–¥–µ–æ</h3>
                </div>
                <div class="player-wrapper" id="playerWrapper">
                    <iframe id="videoPlayer" frameborder="0" allowfullscreen allow="autoplay; encrypted-media; fullscreen"></iframe>
                    <video id="nativeVideo" class="native-video" controls></video>
                </div>
                
                <div class="player-controls-overlay">
                    <button class="control-btn" id="syncNowBtn" title="–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å–µ–π—á–∞—Å">
                        <i class="fas fa-sync-alt"></i> –°–∏–Ω—Ö—Ä.
                    </button>
                </div>
                
                <div class="sync-status" id="syncStatus">
                    <i class="fas fa-sync-alt fa-spin"></i> –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è...
                </div>
            </div>
            
            <div class="chat-container">
                <div class="chat-header">
                    <span><i class="fas fa-comment"></i> –ß–∞—Ç</span>
                    <span class="online-count" id="onlineCount">0 –æ–Ω–ª–∞–π–Ω</span>
                </div>
                <div class="chat-messages" id="chatMessages"></div>
                <div class="chat-input-area">
                    <input type="text" class="chat-input" id="chatInput" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." disabled>
                    <button class="chat-send-btn" id="sendMessageBtn" disabled>
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== SOCKET.IO –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ====================
        const socket = io();
        
        // ==================== –ü–ï–†–ï–ú–ï–ù–ù–´–ï –°–û–°–¢–û–Ø–ù–ò–Ø ====================
        const state = {
            roomId: null,
            userId: generateUserId(),
            username: generateUsername(),
            isLeader: false,
            currentVideoData: null,
            isPlaying: false,
            currentTime: 0,
            ignoreNextSync: false,
            lastCommandTime: 0,
            participants: new Map()
        };

        // ==================== DOM –≠–õ–ï–ú–ï–ù–¢–´ ====================
        const elements = {
            createRoomBtn: document.getElementById('createRoomBtn'),
            joinRoomBtn: document.getElementById('joinRoomBtn'),
            leaveRoomBtn: document.getElementById('leaveRoomBtn'),
            roomIdInput: document.getElementById('roomIdInput'),
            roomInfo: document.getElementById('roomInfo'),
            currentRoomId: document.getElementById('currentRoomId'),
            copyRoomIdBtn: document.getElementById('copyRoomIdBtn'),
            participantsList: document.getElementById('participantsList'),
            onlineCount: document.getElementById('onlineCount'),
            
            urlInput: document.getElementById('urlInput'),
            loadUrlBtn: document.getElementById('loadUrlBtn'),
            videoPlayer: document.getElementById('videoPlayer'),
            nativeVideo: document.getElementById('nativeVideo'),
            currentVideoTitle: document.getElementById('currentVideoTitle'),
            syncNowBtn: document.getElementById('syncNowBtn'),
            syncStatus: document.getElementById('syncStatus'),
            
            chatMessages: document.getElementById('chatMessages'),
            chatInput: document.getElementById('chatInput'),
            sendMessageBtn: document.getElementById('sendMessageBtn'),
            
            statusIndicator: document.getElementById('statusIndicator'),
            statusText: document.getElementById('statusText')
        };

        // ==================== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ====================
        function generateUserId() {
            return 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        function generateUsername() {
            const names = ['–ö–∏–Ω–æ–º–∞–Ω', 'MovieFan', 'Cinephile', '–ó—Ä–∏—Ç–µ–ª—å', '–°–µ—Ä–∏–∞–ª–æ–º–∞–Ω'];
            return names[Math.floor(Math.random() * names.length)] + Math.floor(Math.random() * 1000);
        }

        function updateConnectionStatus(connected) {
            if (connected) {
                elements.statusIndicator.className = 'status-indicator status-connected';
                elements.statusText.textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ';
            } else {
                elements.statusIndicator.className = 'status-indicator status-disconnected';
                elements.statusText.textContent = '–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è';
            }
        }

        function showSyncStatus(show = true) {
            elements.syncStatus.style.display = show ? 'flex' : 'none';
            if (show) {
                setTimeout(() => {
                    elements.syncStatus.style.display = 'none';
                }, 2000);
            }
        }

        function addSystemMessage(text) {
            const div = document.createElement('div');
            div.className = 'message system';
            const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            div.innerHTML = `
                <div class="text">${text}</div>
                <div class="time">${time}</div>
            `;
            elements.chatMessages.appendChild(div);
            elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;
        }

        function addChatMessage(username, text, isOwn = false) {
            const div = document.createElement('div');
            div.className = `message ${isOwn ? 'own' : 'other'}`;
            const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            div.innerHTML = `
                <div class="sender">${isOwn ? '–í—ã' : username}</div>
                <div class="text">${text}</div>
                <div class="time">${time}</div>
            `;
            elements.chatMessages.appendChild(div);
            elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;
        }

        // ==================== SOCKET.IO –°–û–ë–´–¢–ò–Ø ====================
        socket.on('connect', () => {
            console.log('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —Å–µ—Ä–≤–µ—Ä—É');
            updateConnectionStatus(true);
        });

        socket.on('disconnect', () => {
            console.log('‚ùå –û—Ç–∫–ª—é—á–µ–Ω–æ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞');
            updateConnectionStatus(false);
        });

        socket.on('room-info', (data) => {
            console.log('üì° –ü–æ–ª—É—á–µ–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–º–Ω–∞—Ç–µ:', data);
            state.isLeader = data.yourRole === 'leader';
            state.roomId = data.roomId;
            updateParticipantsList(data.participants);
            elements.onlineCount.textContent = `${data.participants.length} –æ–Ω–ª–∞–π–Ω`;
            
            // –ò–°–ü–†–ê–í–õ–ï–ù–û –ë–ê–ì #1: –í—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –∫–æ—Ç–æ—Ä–∞—è –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–æ–º–Ω–∞—Ç—É –∏ ID
            handleJoinRoomSuccess(data.roomId);
            
            // –°–∏—Å—Ç–µ–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–∏
            addSystemMessage(`‚úÖ –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª–∏—Å—å –∫ –∫–æ–º–Ω–∞—Ç–µ: ${data.roomId}`);
            
            if (state.isLeader) {
                addSystemMessage('üëë –í—ã –í–ï–î–£–©–ò–ô. –¢–æ–ª—å–∫–æ –≤—ã –º–æ–∂–µ—Ç–µ —É–ø—Ä–∞–≤–ª—è—Ç—å –≤–∏–¥–µ–æ');
                elements.loadUrlBtn.disabled = false;
                elements.urlInput.disabled = false;
            } else {
                addSystemMessage('üë• –í—ã –ó–†–ò–¢–ï–õ–¨. –°–ª–µ–¥—É–µ—Ç–µ –∑–∞ –≤–µ–¥—É—â–∏–º');
                elements.loadUrlBtn.disabled = true;
                elements.urlInput.disabled = true;
            }
        });

        socket.on('participant-joined', (data) => {
            console.log('üë§ –ù–æ–≤—ã–π —É—á–∞—Å—Ç–Ω–∏–∫:', data);
            updateParticipantsList(data.participants);
            elements.onlineCount.textContent = `${data.participants.length} –æ–Ω–ª–∞–π–Ω`;
            addSystemMessage(`${data.message}`);
        });

        socket.on('participant-left', (data) => {
            console.log('üë§ –£—á–∞—Å—Ç–Ω–∏–∫ —É—à–µ–ª:', data);
            updateParticipantsList(data.participants);
            elements.onlineCount.textContent = `${data.participants.length} –æ–Ω–ª–∞–π–Ω`;
            addSystemMessage(`${data.message}`);
        });

        socket.on('leadership-transferred', (data) => {
            console.log('üëë –†–æ–ª—å –ø–µ—Ä–µ–¥–∞–Ω–∞:', data);
            addSystemMessage(`${data.message}`);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –Ω–∞–º –ª–∏ –ø–µ—Ä–µ–¥–∞–ª–∏ —Ä–æ–ª—å
            if (data.newLeaderId === state.userId) {
                state.isLeader = true;
                elements.loadUrlBtn.disabled = false;
                elements.urlInput.disabled = false;
                addSystemMessage('üé¨ –í–∞–º –ø–µ—Ä–µ–¥–∞–Ω–∞ —Ä–æ–ª—å –í–ï–î–£–©–ï–ì–û!');
            } else if (state.isLeader) {
                state.isLeader = false;
                elements.loadUrlBtn.disabled = true;
                elements.urlInput.disabled = true;
                addSystemMessage('üì∫ –í—ã –±–æ–ª—å—à–µ —É–∂–µ –Ω–µ –≤–µ–¥—É—â–∏–π');
            }
        });

        socket.on('kicked', (data) => {
            alert(data.reason);
            leaveRoom();
        });

        socket.on('video-sync', (data) => {
            console.log('üé¨ –ö–æ–º–∞–Ω–¥–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:', data);
            
            // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º —Å–≤–æ–∏ –∫–æ–º–∞–Ω–¥—ã
            if (data.leaderId === state.userId) {
                console.log('üîÑ –≠—Ç–æ –º–æ—è –∫–æ–º–∞–Ω–¥–∞ - –∏–≥–Ω–æ—Ä–∏—Ä—É—é');
                return;
            }
            
            applyVideoCommand(data);
            showSyncStatus(true);
        });

        socket.on('sync-tick', (data) => {
            // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–æ–≤
            if (!state.isLeader && state.currentVideoData && !state.ignoreNextSync) {
                checkAndCorrectSync(data);
            }
        });

        socket.on('sync-response', (data) => {
            // –ü–æ–ª—É—á–∏–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å–∏–Ω—Ö—Ä–æ –∑–∞–ø—Ä–æ—Å–∞
            if (Math.abs(state.currentTime - data.expectedTime) > 1) {
                console.log(`‚ö†Ô∏è –†–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω: —Ç–µ–∫—É—â–µ–µ ${state.currentTime.toFixed(1)}—Å, –æ–∂–∏–¥–∞–µ–º–æ–µ ${data.expectedTime.toFixed(1)}—Å`);
                gentleSync(data.expectedTime);
            }
        });

        socket.on('chat-message', (data) => {
            addChatMessage(data.username, data.message, false);
        });

        socket.on('error', (data) => {
            console.error('‚ùå –û—à–∏–±–∫–∞:', data.message);
            alert('–û—à–∏–±–∫–∞: ' + data.message);
        });

        // ==================== –£–ü–†–ê–í–õ–ï–ù–ò–ï –ö–û–ú–ù–ê–¢–û–ô ====================
        function createRoom() {
            socket.emit('join-room', {
                roomId: 'room_' + Math.random().toString(36).substr(2, 6).toUpperCase(),
                username: state.username
            });
        }

        function joinRoom(roomId) {
            socket.emit('join-room', {
                roomId: roomId,
                username: state.username
            });
        }

        function handleJoinRoomSuccess(roomId) {
            state.roomId = roomId;
            elements.currentRoomId.textContent = roomId;
            elements.roomInfo.style.display = 'flex';
            
            elements.createRoomBtn.disabled = true;
            elements.joinRoomBtn.disabled = true;
            elements.roomIdInput.disabled = true;
            elements.leaveRoomBtn.style.display = 'inline-block';
            elements.chatInput.disabled = false;
            elements.sendMessageBtn.disabled = false;
            
            elements.roomIdInput.value = '';
        }

        function leaveRoom() {
            if (!state.roomId) return;
            
            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞
            if (state.currentVideoData) {
                const video = state.currentVideoData.type === 'direct' ? elements.nativeVideo : null;
                if (video) {
                    video.pause();
                    video.src = '';
                }
            }
            
            state.roomId = null;
            state.isLeader = false;
            state.currentVideoData = null;
            
            elements.roomInfo.style.display = 'none';
            elements.createRoomBtn.disabled = false;
            elements.joinRoomBtn.disabled = false;
            elements.roomIdInput.disabled = false;
            elements.leaveRoomBtn.style.display = 'none';
            elements.chatInput.disabled = true;
            elements.sendMessageBtn.disabled = true;
            elements.loadUrlBtn.disabled = true;
            elements.urlInput.disabled = true;
            
            elements.nativeVideo.pause();
            elements.nativeVideo.src = '';
            elements.videoPlayer.src = '';
            elements.nativeVideo.style.display = 'none';
            elements.videoPlayer.style.display = 'block';
            elements.currentVideoTitle.textContent = '–í—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ –≤–∏–¥–µ–æ';
            
            addSystemMessage('üëã –í—ã –ø–æ–∫–∏–Ω—É–ª–∏ –∫–æ–º–Ω–∞—Ç—É');
        }

        function updateParticipantsList(participants) {
            elements.participantsList.innerHTML = '';
            participants.forEach(p => {
                const badge = document.createElement('div');
                badge.className = `user-badge ${p.role === 'leader' ? 'host' : ''}`;
                badge.innerHTML = `
                    <i class="${p.role === 'leader' ? 'fas fa-crown' : 'fas fa-user'}"></i>
                    <span>${p.username}</span>
                    ${p.role === 'leader' ? '<span class="role-badge">–í–ï–î–£–©–ò–ô</span>' : ''}
                `;
                elements.participantsList.appendChild(badge);
            });
        }

        // ==================== –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø –í–ò–î–ï–û ====================
        function parseVideoUrl(url) {
            try {
                const urlLower = url.toLowerCase();
                
                // –ü—Ä—è–º—ã–µ –≤–∏–¥–µ–æ —Ñ–∞–π–ª—ã
                if (urlLower.match(/\.(mp4|webm|ogg|mov|avi)$/)) {
                    return {
                        type: 'direct',
                        url: url,
                        title: '–í–∏–¥–µ–æ'
                    };
                }
                
                // Rutube
                if (urlLower.includes('rutube.ru')) {
                    const match = url.match(/\/video\/([a-z0-9]+)/i);
                    if (match) {
                        return {
                            type: 'rutube',
                            embedUrl: `https://rutube.ru/play/embed/${match[1]}/`,
                            title: 'Rutube –≤–∏–¥–µ–æ'
                        };
                    }
                }
                
                // VK
                if (urlLower.includes('vk.com') || urlLower.includes('vkontakte.ru')) {
                    const match = url.match(/video(-?\d+)_(\d+)/);
                    if (match) {
                        return {
                            type: 'vk',
                            embedUrl: `https://vk.com/video_ext.php?oid=${match[1]}&id=${match[2]}&autoplay=1`,
                            title: 'VK –≤–∏–¥–µ–æ'
                        };
                    }
                }
                
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ URL:', e);
            }
            
            return null;
        }

        function loadVideo(url) {
            if (!state.isLeader) {
                alert('–¢–æ–ª—å–∫–æ –≤–µ–¥—É—â–∏–π –º–æ–∂–µ—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å –≤–∏–¥–µ–æ!');
                return;
            }
            
            const videoData = parseVideoUrl(url);
            if (!videoData) {
                alert('–ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–∞—è —Å—Å—ã–ª–∫–∞. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ:\n- –ü—Ä—è–º—ã–µ MP4/WebM —Å—Å—ã–ª–∫–∏\n- Rutube\n- VK');
                return;
            }
            
            state.currentVideoData = videoData;
            elements.currentVideoTitle.textContent = videoData.title;
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–æ–º–∞–Ω–¥—É –≤–µ–¥—É—â–µ–≥–æ –Ω–∞ –∑–∞–≥—Ä—É–∑–∫—É –≤–∏–¥–µ–æ
            socket.emit('video-command', {
                action: 'load',
                url: url,
                title: videoData.title,
                type: videoData.type
            });
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –ª–æ–∫–∞–ª—å–Ω–æ
            renderVideo(videoData);
            setupVideoListeners();
            
            elements.urlInput.value = '';
            addSystemMessage(`üé¨ –í–ï–î–£–©–ò–ô –∑–∞–≥—Ä—É–∑–∏–ª: ${videoData.title}`);
        }

        function renderVideo(videoData) {
            if (videoData.type === 'direct') {
                elements.nativeVideo.style.display = 'block';
                elements.videoPlayer.style.display = 'none';
                elements.nativeVideo.src = videoData.url;
                elements.nativeVideo.load();
            } else {
                elements.videoPlayer.style.display = 'block';
                elements.nativeVideo.style.display = 'none';
                elements.videoPlayer.src = videoData.embedUrl;
            }
        }

        function setupVideoListeners() {
            if (!elements.nativeVideo) return;
            
            const video = elements.nativeVideo;
            let seekTimeout;
            
            video.addEventListener('play', () => {
                if (!state.isLeader || state.ignoreNextSync) {
                    state.ignoreNextSync = false;
                    return;
                }
                
                if (!state.roomId) return;
                
                console.log('‚ñ∂Ô∏è –í–ï–î–£–©–ò–ô –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç play');
                socket.emit('video-command', {
                    action: 'play',
                    time: video.currentTime
                });
            });
            
            video.addEventListener('pause', () => {
                if (!state.isLeader || state.ignoreNextSync) {
                    state.ignoreNextSync = false;
                    return;
                }
                
                if (!state.roomId) return;
                
                console.log('‚è∏Ô∏è –í–ï–î–£–©–ò–ô –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç pause');
                socket.emit('video-command', {
                    action: 'pause',
                    time: video.currentTime
                });
            });
            
            video.addEventListener('seeked', () => {
                if (!state.isLeader || state.ignoreNextSync) {
                    state.ignoreNextSync = false;
                    return;
                }
                
                if (!state.roomId) return;
                
                clearTimeout(seekTimeout);
                seekTimeout = setTimeout(() => {
                    console.log(`‚è™ –í–ï–î–£–©–ò–ô –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç seek –Ω–∞ ${video.currentTime.toFixed(1)}s`);
                    socket.emit('video-command', {
                        action: 'seek',
                        time: video.currentTime
                    });
                }, 300);
            });
        }

        function applyVideoCommand(data) {
            const video = elements.nativeVideo;
            
            if (data.type === 'direct' && video) {
                state.ignoreNextSync = true;
                
                switch (data.action) {
                    case 'play':
                        video.currentTime = data.time;
                        video.play().catch(e => console.log('–û—à–∏–±–∫–∞ play:', e));
                        break;
                    case 'pause':
                        video.currentTime = data.time;
                        video.pause();
                        break;
                    case 'seek':
                        video.currentTime = data.time;
                        break;
                }
            }
        }

        function checkAndCorrectSync(data) {
            const video = elements.nativeVideo;
            if (!video || !state.currentVideoData || state.currentVideoData.type !== 'direct') return;
            
            const diff = Math.abs(video.currentTime - data.expectedTime);
            if (diff > 2) { // –î–æ–ø—É—Å–∫ 2 —Å–µ–∫—É–Ω–¥—ã
                console.log(`‚ö†Ô∏è –†–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω ${diff.toFixed(1)}s, –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É—é`);
                gentleSync(data.expectedTime);
            }
        }

        function gentleSync(targetTime) {
            const video = elements.nativeVideo;
            if (!video) return;
            
            state.ignoreNextSync = true;
            video.currentTime = targetTime;
            setTimeout(() => {
                state.ignoreNextSync = false;
            }, 200);
        }

        // ==================== –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –ö–ù–û–ü–û–ö ====================
        elements.createRoomBtn.addEventListener('click', () => {
            createRoom();
        });

        elements.joinRoomBtn.addEventListener('click', () => {
            const roomId = elements.roomIdInput.value.trim();
            if (roomId) {
                joinRoom(roomId);
            } else {
                alert('–í–≤–µ–¥–∏—Ç–µ ID –∫–æ–º–Ω–∞—Ç—ã');
            }
        });

        elements.leaveRoomBtn.addEventListener('click', () => {
            leaveRoom();
        });

        elements.copyRoomIdBtn.addEventListener('click', () => {
            navigator.clipboard.writeText(elements.currentRoomId.textContent).then(() => {
                alert('ID —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!');
            });
        });

        elements.loadUrlBtn.addEventListener('click', () => {
            loadVideo(elements.urlInput.value.trim());
        });

        elements.urlInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') elements.loadUrlBtn.click();
        });

        elements.syncNowBtn.addEventListener('click', () => {
            if (state.isLeader) {
                socket.emit('request-sync', { clientTime: Date.now() });
            }
            showSyncStatus(true);
        });

        elements.sendMessageBtn.addEventListener('click', () => {
            const text = elements.chatInput.value.trim();
            if (text) {
                socket.emit('send-chat-message', { message: text });
                addChatMessage(state.username, text, true);
                elements.chatInput.value = '';
            }
        });

        elements.chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') elements.sendMessageBtn.click();
        });

        // ==================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ====================
        updateConnectionStatus(false);
        addSystemMessage('üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ CINEMATE v2.0!');
        addSystemMessage('üé¨ –°–æ–∑–¥–∞–π—Ç–µ –∫–æ–º–Ω–∞—Ç—É –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ ID —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π');

        window.addEventListener('beforeunload', () => {
            if (state.roomId) {
                leaveRoom();
            }
        });
    </script>
</body>
</html>
