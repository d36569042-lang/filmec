<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>CINEMATE</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0b0e14; 
            color: white; 
            min-height: 100vh;
        }
        .container { max-width: 1400px; margin: 0 auto; padding: 16px; }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 10px 0;
            flex-wrap: wrap;
            gap: 15px;
        }

        .nick-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .nick-input {
            padding: 8px 12px;
            border-radius: 20px;
            border: 1px solid #333;
            background: #0b0e14;
            color: white;
            outline: none;
            font-size: 13px;
            width: 160px;
        }

        .nick-btn {
            background: #2a2f3a;
            color: #fff;
            border: 1px solid #333;
            padding: 8px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
        }
        
        .logo {
            font-size: 24px;
            font-weight: 600;
        }
        
        .logo i {
            color: #5f7cff;
            margin-right: 8px;
        }
        
        .connection-status {
            background: #1a1f2b;
            padding: 8px 16px;
            border-radius: 50px;
            font-size: 14px;
            border: 1px solid #333;
        }
        
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-connected { background: #4caf50; box-shadow: 0 0 10px #4caf50; }
        .status-disconnected { background: #ff6b6b; }
        .status-connecting { background: #ffaa00; }
        
        .guide {
            background: #1a1f2b;
            border-radius: 16px;
            padding: 15px 20px;
            margin-bottom: 20px;
            border-left: 4px solid #5f7cff;
        }
        
        .guide h4 {
            color: #5f7cff;
            margin-bottom: 10px;
        }
        
        .guide ol {
            margin-left: 20px;
            color: #aaa;
            line-height: 1.6;
        }
        
        .room-section {
            background: #1a1f2b;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #333;
        }
        
        .room-title {
            font-size: 18px;
            margin-bottom: 15px;
            color: #5f7cff;
        }
        
        .room-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .room-btn {
            background: #5f7cff;
            border: none;
            color: white;
            padding: 12px 25px;
            border-radius: 50px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
            font-size: 14px;
        }
        
        .room-btn.secondary {
            background: #2a2f3a;
        }
        
        .room-btn.danger {
            background: #ff6b6b;
        }
        
        .room-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            filter: brightness(1.1);
        }
        
        .room-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .room-input {
            background: #0b0e14;
            border: 1px solid #333;
            color: white;
            padding: 12px 15px;
            border-radius: 50px;
            outline: none;
        }
        
        .room-input:focus {
            border-color: #5f7cff;
        }
        
        .room-info {
            margin-top: 15px;
            padding: 15px;
            background: #0b0e14;
            border-radius: 12px;
            border: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .room-id-box {
            display: flex;
            align-items: center;
            gap: 10px;
            background: #1a1f2b;
            padding: 8px 16px;
            border-radius: 50px;
        }
        
        .room-id {
            font-family: monospace;
            font-size: 18px;
            color: #5f7cff;
            font-weight: 600;
        }
        
        .copy-btn {
            background: none;
            border: none;
            color: #888;
            cursor: pointer;
            font-size: 16px;
        }
        
        .copy-btn:hover {
            color: #5f7cff;
        }
        
        .users-list {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .user-badge {
            background: #2a2f3a;
            padding: 5px 12px;
            border-radius: 50px;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .user-badge.host {
            background: #5f7cff;
        }
        
        .user-badge i {
            font-size: 12px;
        }
        
        .url-section {
            margin-bottom: 20px;
        }
        
        .url-box {
            display: flex;
            gap: 10px;
            background: #1a1f2b;
            border-radius: 50px;
            padding: 5px;
            border: 1px solid #333;
        }
        
        .url-box input {
            flex: 1;
            background: transparent;
            border: none;
            padding: 15px 20px;
            color: white;
            font-size: 16px;
            outline: none;
        }
        
        .url-box button {
            background: #5f7cff;
            border: none;
            border-radius: 50px;
            padding: 0 30px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
            white-space: nowrap;
        }
        
        .url-box button:hover {
            background: #738dff;
        }
        
        @media (max-width: 600px) {
            .url-box {
                flex-direction: column;
                border-radius: 12px;
                padding: 8px;
                gap: 8px;
            }
            
            .url-box input {
                padding: 12px 15px;
                border-radius: 8px;
                background: #0b0e14;
                border: 1px solid #333;
                font-size: 14px;
            }
            
            .url-box button {
                padding: 12px 20px;
                border-radius: 8px;
                width: 100%;
                font-size: 14px;
            }
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 320px;
            gap: 20px;
            height: calc(100vh - 300px);
            min-height: 500px;
        }
        
        .player-container {
            background: #000;
            border-radius: 16px;
            overflow: hidden;
            position: relative;
            border: 1px solid #333;
            display: flex;
            flex-direction: column;
        }
        
        .player-header {
            padding: 16px;
            background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            z-index: 10;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .player-header h3 {
            font-size: 16px;
            max-width: 70%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: white;
        }
        
        .player-wrapper {
            flex: 1;
            background: #000;
            position: relative;
        }
        
        #videoPlayer {
            width: 100%;
            height: 100%;
            border: none;
            display: none;
        }
        
        .native-video {
            width: 100%;
            height: 100%;
            background: #000;
            display: none;
        }
        
        .player-controls-overlay {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            justify-content: center;
            z-index: 20;
            flex-wrap: wrap;
        }
        
        .control-btn {
            background: rgba(95, 124, 255, 0.9);
            border: none;
            color: white;
            padding: 12px 25px;
            border-radius: 50px;
            font-weight: 600;
            cursor: pointer;
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            gap: 8px;
            transition: 0.2s;
        }
        
        .control-btn:hover {
            background: #5f7cff;
        }
        
        .sync-status {
            position: absolute;
            top: 70px;
            right: 20px;
            background: rgba(76, 175, 80, 0.9);
            color: white;
            padding: 8px 16px;
            border-radius: 50px;
            font-size: 13px;
            z-index: 30;
            display: none;
            align-items: center;
            gap: 8px;
        }
        
        .chat-container {
            background: #1a1f2b;
            border-radius: 16px;
            border: 1px solid #333;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .chat-header {
            padding: 15px;
            border-bottom: 1px solid #333;
            font-weight: 600;
            color: #5f7cff;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .online-count {
            background: #2a2f3a;
            padding: 3px 10px;
            border-radius: 50px;
            font-size: 12px;
            color: #aaa;
        }
        
        .chat-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .message {
            padding: 8px 12px;
            border-radius: 12px;
            max-width: 85%;
            word-wrap: break-word;
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .message.own {
            background: #5f7cff;
            align-self: flex-end;
        }
        
        .message.other {
            background: #2a2f3a;
            align-self: flex-start;
        }
        
        .message.system {
            background: #333;
            align-self: center;
            max-width: 90%;
            text-align: center;
            font-style: italic;
            opacity: 0.8;
            font-size: 12px;
        }
        
        .message .sender {
            font-size: 12px;
            opacity: 0.7;
            margin-bottom: 4px;
        }
        
        .message .text {
            font-size: 14px;
            line-height: 1.4;
        }
        
        .message .time {
            font-size: 10px;
            opacity: 0.5;
            text-align: right;
            margin-top: 4px;
        }
        
        .chat-input-area {
            padding: 15px;
            border-top: 1px solid #333;
            display: flex;
            gap: 10px;
        }
        
        .chat-input {
            flex: 1;
            background: #0b0e14;
            border: 1px solid #333;
            color: white;
            padding: 12px;
            border-radius: 25px;
            outline: none;
        }
        
        .chat-input:focus {
            border-color: #5f7cff;
        }
        
        .chat-send-btn {
            background: #5f7cff;
            border: none;
            color: white;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            cursor: pointer;
            transition: 0.2s;
        }
        
        .chat-send-btn:hover:not(:disabled) {
            background: #738dff;
        }
        
        .chat-send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .role-badge {
            background: #5f7cff;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            margin-left: 5px;
        }
        
        @media (max-width: 900px) {
            .main-content {
                grid-template-columns: 1fr;
                height: auto;
            }
            
            .player-container {
                height: 50vh;
            }
            
            .chat-container {
                height: 400px;
            }
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                align-items: flex-start;
            }

            .logo {
                width: 100%;
            }

            .connection-status {
                width: 100%;
                justify-content: center;
                text-align: center;
            }

            .nick-controls {
                width: 100%;
            }

            .room-controls {
                flex-direction: column;
            }

            .room-btn {
                width: 100%;
            }

            .room-info {
                flex-direction: column;
                align-items: flex-start;
            }

            .player-controls-overlay {
                flex-direction: column;
                gap: 8px;
                bottom: 10px;
                left: 10px;
                right: 10px;
            }

            .control-btn {
                width: 100%;
                justify-content: center;
            }
        }

        @media (max-width: 600px) {
            .container {
                padding: 8px;
            }

            .logo {
                font-size: 20px;
            }

            .guide {
                padding: 12px 16px;
                margin-bottom: 15px;
            }

            .guide ol {
                margin-left: 15px;
                font-size: 13px;
            }

            .room-section {
                padding: 15px;
                margin-bottom: 15px;
            }

            .room-title {
                font-size: 16px;
                margin-bottom: 12px;
            }

            .room-input {
                padding: 10px 12px;
                font-size: 14px;
            }

            .room-info {
                margin-top: 12px;
                padding: 12px;
                gap: 8px;
            }

            .users-list {
                width: 100%;
            }

            .user-badge {
                padding: 4px 10px;
                font-size: 12px;
            }

            .chat-messages {
                padding: 10px;
                gap: 8px;
            }

            .message {
                padding: 6px 10px;
                font-size: 13px;
            }

            .chat-input-area {
                padding: 12px;
                gap: 8px;
            }

            .chat-input {
                padding: 10px;
                font-size: 14px;
            }

            .chat-send-btn {
                width: 40px;
                height: 40px;
            }

            .control-btn {
                padding: 10px 15px;
                font-size: 12px;
            }

            .sync-status {
                top: 60px;
                right: 10px;
                padding: 6px 12px;
                font-size: 12px;
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- HLS.js –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ M3U8 –ø–æ—Ç–æ–∫–æ–≤ (Rutube, YouTube TV –∏ —Ç.–¥.) -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">
                <i class="fas fa-film"></i> CINEMATE 
            </div>
            <div class="connection-status" id="connectionStatus">
                <span class="status-indicator status-disconnected" id="statusIndicator"></span>
                <span id="statusText">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</span>
            </div>
            <div class="nick-controls">
                <input id="nicknameInput" class="nick-input" placeholder="–í–∞—à –Ω–∏–∫" />
                <button id="changeNickBtn" class="nick-btn">–ò–∑–º–µ–Ω–∏—Ç—å</button>
            </div>
        </div>
        
        <div class="guide">
            <h4><i class="fas fa-info-circle"></i> –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:</h4>
            <ol>
                <li><strong>–í–µ–¥—É—â–∏–π</strong> –Ω–∞–∂–∏–º–∞–µ—Ç "–°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É"</li>
                <li><strong>–í–µ–¥—É—â–∏–π</strong> –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç ID –ø–æ–¥—Ä—É–≥–µ (—Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–Ω–æ–ø–∫—É)</li>
                <li><strong>–ó—Ä–∏—Ç–µ–ª—å</strong> –≤—Å—Ç–∞–≤–ª—è–µ—Ç ID ‚Üí –Ω–∞–∂–∏–º–∞–µ—Ç "–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è"</li>
                <li><strong>–í–µ–¥—É—â–∏–π</strong> –∑–∞–≥—Ä—É–∂–∞–µ—Ç –≤–∏–¥–µ–æ (—Ç–æ–ª—å–∫–æ –≤–µ–¥—É—â–∏–π –º–æ–∂–µ—Ç)</li>
                <li>–í—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</li>
            </ol>
        </div>
        
        <div class="room-section">
            <div class="room-title">
                <i class="fas fa-users"></i> –ö–æ–º–Ω–∞—Ç–∞ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
            </div>
            <div class="room-controls">
                <button class="room-btn" id="createRoomBtn">
                    <i class="fas fa-plus-circle"></i> –°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É
                </button>
                <input type="text" class="room-input" id="roomIdInput" placeholder="–í–≤–µ–¥–∏—Ç–µ ID –∫–æ–º–Ω–∞—Ç—ã">
                <button class="room-btn secondary" id="joinRoomBtn">
                    <i class="fas fa-door-open"></i> –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è
                </button>
                <button class="room-btn danger" id="leaveRoomBtn" style="display: none;">
                    <i class="fas fa-sign-out-alt"></i> –ü–æ–∫–∏–Ω—É—Ç—å
                </button>
            </div>
            
            <div class="room-info" id="roomInfo" style="display: none;">
                <div class="room-id-box">
                    <i class="fas fa-door-open"></i>
                    <span class="room-id" id="currentRoomId"></span>
                    <button class="copy-btn" id="copyRoomIdBtn" title="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å ID">
                        <i class="far fa-copy"></i>
                    </button>
                </div>
                <div class="users-list" id="participantsList"></div>
            </div>
        </div>
        
        <div class="url-section">
            <div class="url-box">
                <input type="text" id="urlInput" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ –≤–∏–¥–µ–æ (MP4, Rutube, VK)">
                <button id="loadUrlBtn"><i class="fas fa-play"></i> –ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
            </div>
        </div>
        
        <div class="main-content">
            <div class="player-container" id="playerContainer">
                <div class="player-header">
                    <h3 id="currentVideoTitle">–í—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ –≤–∏–¥–µ–æ</h3>
                </div>
                <div class="player-wrapper" id="playerWrapper">
                    <iframe id="videoPlayer" frameborder="0" allow="autoplay; encrypted-media; fullscreen; accelerometer; gyroscope; picture-in-picture" allowfullscreen sandbox="allow-same-origin allow-scripts allow-presentation allow-popups"></iframe>
                    <video id="nativeVideo" class="native-video" controls crossorigin="use-credentials"></video>
                </div>
                
                <div class="player-controls-overlay">
                    <button class="control-btn" id="syncNowBtn" title="–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å–µ–π—á–∞—Å">
                        <i class="fas fa-sync-alt"></i> –°–∏–Ω—Ö—Ä.
                    </button>
                </div>
                
                <div class="sync-status" id="syncStatus">
                    <i class="fas fa-sync-alt fa-spin"></i> –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è...
                </div>
            </div>
            
            <div class="chat-container">
                <div class="chat-header">
                    <span><i class="fas fa-comment"></i> –ß–∞—Ç</span>
                    <span class="online-count" id="onlineCount">0 –æ–Ω–ª–∞–π–Ω</span>
                </div>
                <div class="chat-messages" id="chatMessages"></div>
                <div class="chat-input-area">
                    <input type="text" class="chat-input" id="chatInput" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." disabled>
                    <button class="chat-send-btn" id="sendMessageBtn" disabled>
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script>
        // ==================== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –ë–≠–ö–ï–ù–î–ê ====================
        // –î–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ http://localhost:3000
        // –î–ª—è Render –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ https://–≤–∞—à–ø—Ä–æ–µ–∫—Ç.onrender.com
        // –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–∫—Ä—É–∂–µ–Ω–∏—è Netlify: REACT_APP_BACKEND_URL
        
        let BACKEND_URL = null;
        
        // ===== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –í–ê–®–ò–• –ê–î–†–ï–°–û–í =====
        // Render –±—ç–∫–µ–Ω–¥: https://cinemate-server-u0w8.onrender.com
        // Netlify —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥: https://filmkaif.netlify.app/
        
        // –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–ª—É—á–∏—Ç—å URL –∏–∑ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
        function initBackendUrl() {
            // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º localStorage (—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ)
            if (localStorage.getItem('backendUrl')) {
                BACKEND_URL = localStorage.getItem('backendUrl');
                console.log(`‚úÖ Backend URL –∏–∑ localStorage: ${BACKEND_URL}`);
                return;
            }
            
            // 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é (—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ Netlify)
            if (window.BACKEND_URL) {
                BACKEND_URL = window.BACKEND_URL;
                localStorage.setItem('backendUrl', BACKEND_URL);
                console.log(`‚úÖ Backend URL –∏–∑ –≥–ª–æ–±–∞–ª—å–Ω–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π: ${BACKEND_URL}`);
                return;
            }
            
            // 3. –î–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ host - –∏—Å–ø–æ–ª—å–∑—É–µ–º localhost
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                BACKEND_URL = 'http://localhost:3000';
                localStorage.setItem('backendUrl', BACKEND_URL);
                console.log(`‚úÖ Backend URL –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ö–æ—Å—Ç–∞: ${BACKEND_URL}`);
                return;
            }
            
            // 4. –î–ª—è production Netlify - –∏—Å–ø–æ–ª—å–∑—É–µ–º Render URL –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            if (window.location.hostname === 'filmkaif.netlify.app') {
                BACKEND_URL = 'https://cinemate-server-u0w8.onrender.com';
                localStorage.setItem('backendUrl', BACKEND_URL);
                console.log(`‚úÖ Backend URL –¥–ª—è production: ${BACKEND_URL}`);
                return;
            }
            
            // 5. –ü—Ä–æ—Å–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤–≤–µ—Å—Ç–∏ URL (–¥–ª—è –¥—Ä—É–≥–∏—Ö —Å–ª—É—á–∞–µ–≤)
            const savedUrl = prompt(
                '–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–æ, –Ω–æ –Ω—É–∂–µ–Ω –∞–¥—Ä–µ—Å –±—ç–∫–µ–Ω–¥–∞.\n\n' +
                '–í–≤–µ–¥–∏—Ç–µ URL b—ç–∫—ç–Ω–¥–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: https://cinemate-server-u0w8.onrender.com):\n\n' +
                '–≠—Ç–æ—Ç URL –±—É–¥–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ localStorage',
                'https://cinemate-server-u0w8.onrender.com'
            );
            
            if (savedUrl) {
                BACKEND_URL = savedUrl.trim();
                if (!BACKEND_URL.startsWith('http')) {
                    BACKEND_URL = 'https://' + BACKEND_URL;
                }
                localStorage.setItem('backendUrl', BACKEND_URL);
                console.log(`‚úÖ Backend URL —Å–æ—Ö—Ä–∞–Ω–µ–Ω: ${BACKEND_URL}`);
                alert(`‚úÖ URL —Å–æ—Ö—Ä–∞–Ω–µ–Ω: ${BACKEND_URL}\n\n–û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è`);
            } else {
                BACKEND_URL = 'https://cinemate-server-u0w8.onrender.com'; // Fallback
                localStorage.setItem('backendUrl', BACKEND_URL);
                console.warn(`‚ö†Ô∏è –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è fallback: ${BACKEND_URL}`);
            }
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º URL
        initBackendUrl();
        
        // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –¥–ª—è —Å–º–µ–Ω—ã URL (Debug)
        window.changeBackendUrl = function() {
            const newUrl = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –∞–¥—Ä–µ—Å –±—ç–∫–µ–Ω–¥–∞:', BACKEND_URL);
            if (newUrl) {
                BACKEND_URL = newUrl;
                localStorage.setItem('backendUrl', BACKEND_URL);
                alert('URL –∏–∑–º–µ–Ω–µ–Ω! –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É');
                location.reload();
            }
        };
        
        console.log(`üåê –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±—ç–∫–µ–Ω–¥—É: ${BACKEND_URL}`);

        // ==================== SOCKET.IO –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ====================
        const socket = io(BACKEND_URL, {
            reconnection: true,
            reconnectionDelay: 1000,
            reconnectionDelayMax: 5000,
            reconnectionAttempts: 5
        });
        
        // ==================== –ü–ï–†–ï–ú–ï–ù–ù–´–ï –°–û–°–¢–û–Ø–ù–ò–Ø ====================
        const state = {
            roomId: null,
            userId: generateUserId(),
            username: generateUsername(),
            isLeader: false,
            currentVideoData: null,
            isPlaying: false,
            currentTime: 0,
            ignoreNextSync: false,
            lastCommandTime: 0,
            participants: new Map(),
            embedSyncInterval: null,  // –ù–û–í–û–ï: –î–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ embed –≤–∏–¥–µ–æ
            embedHeartbeatTimeout: null,  // –ù–û–í–û–ï: –¢–∞–π–º–∞—É—Ç heartbeat
            lastEmbedHeartbeat: null  // –ù–û–í–û–ï: –í—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ heartbeat
        };

        // ==================== DOM –≠–õ–ï–ú–ï–ù–¢–´ ====================
        const elements = {
            createRoomBtn: document.getElementById('createRoomBtn'),
            joinRoomBtn: document.getElementById('joinRoomBtn'),
            leaveRoomBtn: document.getElementById('leaveRoomBtn'),
            roomIdInput: document.getElementById('roomIdInput'),
            roomInfo: document.getElementById('roomInfo'),
            currentRoomId: document.getElementById('currentRoomId'),
            copyRoomIdBtn: document.getElementById('copyRoomIdBtn'),
            participantsList: document.getElementById('participantsList'),
            onlineCount: document.getElementById('onlineCount'),
            nicknameInput: document.getElementById('nicknameInput'),
            changeNickBtn: document.getElementById('changeNickBtn'),
            
            urlInput: document.getElementById('urlInput'),
            loadUrlBtn: document.getElementById('loadUrlBtn'),
            videoPlayer: document.getElementById('videoPlayer'),
            nativeVideo: document.getElementById('nativeVideo'),
            currentVideoTitle: document.getElementById('currentVideoTitle'),
            syncNowBtn: document.getElementById('syncNowBtn'),
            syncStatus: document.getElementById('syncStatus'),
            
            chatMessages: document.getElementById('chatMessages'),
            chatInput: document.getElementById('chatInput'),
            sendMessageBtn: document.getElementById('sendMessageBtn'),
            
            statusIndicator: document.getElementById('statusIndicator'),
            statusText: document.getElementById('statusText')
        };

        // ==================== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ====================
        function generateUserId() {
            return 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        function generateUsername() {
            const names = ['–ö–∏–Ω–æ–º–∞–Ω', 'MovieFan', 'Cinephile', '–ó—Ä–∏—Ç–µ–ª—å', '–°–µ—Ä–∏–∞–ª–æ–º–∞–Ω'];
            return names[Math.floor(Math.random() * names.length)] + Math.floor(Math.random() * 1000);
        }

        function updateConnectionStatus(connected) {
            if (connected) {
                elements.statusIndicator.className = 'status-indicator status-connected';
                elements.statusText.textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ';
            } else {
                elements.statusIndicator.className = 'status-indicator status-disconnected';
                elements.statusText.textContent = '–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è';
            }
        }

        function showSyncStatus(show = true) {
            elements.syncStatus.style.display = show ? 'flex' : 'none';
            if (show) {
                setTimeout(() => {
                    elements.syncStatus.style.display = 'none';
                }, 2000);
            }
        }

        function addSystemMessage(text) {
            const div = document.createElement('div');
            div.className = 'message system';
            const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            div.innerHTML = `
                <div class="text">${text}</div>
                <div class="time">${time}</div>
            `;
            elements.chatMessages.appendChild(div);
            elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;
        }

        function addChatMessage(username, text, isOwn = false) {
            const div = document.createElement('div');
            div.className = `message ${isOwn ? 'own' : 'other'}`;
            const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            div.innerHTML = `
                <div class="sender">${isOwn ? '–í—ã' : username}</div>
                <div class="text">${text}</div>
                <div class="time">${time}</div>
            `;
            elements.chatMessages.appendChild(div);
            elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;
        }

        // ==================== SOCKET.IO –°–û–ë–´–¢–ò–Ø ====================
        socket.on('connect', () => {
            console.log('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —Å–µ—Ä–≤–µ—Ä—É');
            updateConnectionStatus(true);
        });

        socket.on('disconnect', () => {
            console.log('‚ùå –û—Ç–∫–ª—é—á–µ–Ω–æ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞');
            updateConnectionStatus(false);
        });
        // ========== –û–ë–†–ê–ë–û–¢–ö–ê –û–®–ò–ë–û–ö –°–ï–¢–ò ==========
socket.on('connect_error', (error) => {
    console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:', error);
    updateConnectionStatus(false);
    addSystemMessage('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É. –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...');
});

socket.io.on("reconnect", (attempt) => {
    console.log(`‚úÖ –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–æ –ø–æ—Å–ª–µ ${attempt} –ø–æ–ø—ã—Ç–æ–∫`);
    addSystemMessage('‚úÖ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
    updateConnectionStatus(true);
    
    // –ï—Å–ª–∏ –±—ã–ª–∏ –≤ –∫–æ–º–Ω–∞—Ç–µ, –ø—ã—Ç–∞–µ–º—Å—è –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è
    if (state.roomId) {
        setTimeout(() => {
            socket.emit('join-room', {
                roomId: state.roomId,
                username: state.username
            });
        }, 500);
    }
});

socket.io.on("reconnect_attempt", (attempt) => {
    console.log(`üîÑ –ü–æ–ø—ã—Ç–∫–∞ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è #${attempt}`);
});

socket.io.on("reconnect_error", (error) => {
    console.error('‚ùå –û—à–∏–±–∫–∞ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:', error);
});

socket.io.on("reconnect_failed", () => {
    console.error('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è');
    addSystemMessage('‚ùå –ü–æ—Ç–µ—Ä—è–Ω–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å —Å–µ—Ä–≤–µ—Ä–æ–º. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
    updateConnectionStatus(false);
});

        socket.on('room-info', (data) => {
    console.log('üì° –ü–æ–ª—É—á–µ–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–º–Ω–∞—Ç–µ:', data);
    state.isLeader = data.yourRole === 'leader';
    state.roomId = data.roomId;
    updateParticipantsList(data.participants);
    elements.onlineCount.textContent = `${data.participants.length} –æ–Ω–ª–∞–π–Ω`;
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–º–Ω–∞—Ç–µ
    handleJoinRoomSuccess(data.roomId);
    
    // –°–∏—Å—Ç–µ–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–∏
    addSystemMessage(`‚úÖ –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª–∏—Å—å –∫ –∫–æ–º–Ω–∞—Ç–µ: ${data.roomId}`);
    
    if (state.isLeader) {
        addSystemMessage('üëë –í—ã –í–ï–î–£–©–ò–ô. –¢–æ–ª—å–∫–æ –≤—ã –º–æ–∂–µ—Ç–µ —É–ø—Ä–∞–≤–ª—è—Ç—å –≤–∏–¥–µ–æ');
        elements.loadUrlBtn.disabled = false;
        elements.urlInput.disabled = false;
    } else {
        addSystemMessage('üë• –í—ã –ó–†–ò–¢–ï–õ–¨. –°–ª–µ–¥—É–µ—Ç–µ –∑–∞ –≤–µ–¥—É—â–∏–º');
        elements.loadUrlBtn.disabled = true;
        elements.urlInput.disabled = true;
    }
    
    // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ó–∞–≥—Ä—É–∂–∞–µ–º –≤–∏–¥–µ–æ –µ—Å–ª–∏ –æ–Ω–æ –µ—Å—Ç—å –≤ –∫–æ–º–Ω–∞—Ç–µ
    if (data.videoState && data.videoState.url) {
        console.log('üé¨ –í –∫–æ–º–Ω–∞—Ç–µ —É–∂–µ –µ—Å—Ç—å –≤–∏–¥–µ–æ, –∑–∞–≥—Ä—É–∂–∞—é...', data.videoState);
        addSystemMessage(`üé¨ –¢–µ–∫—É—â–µ–µ –≤–∏–¥–µ–æ: ${data.videoState.title || '–ó–∞–≥—Ä—É–∑–∫–∞...'}`);
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤–∏–¥–µ–æ
        processLoadedVideo(
            data.videoState.url, 
            data.videoState.title || '–í–∏–¥–µ–æ', 
            null
        );
        
        // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤–∏–¥–µ–æ –ü–û–°–õ–ï –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö
        // –ù–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º setTimeout, –≤–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–æ–±—ã—Ç–∏–µ loadedmetadata
        const video = elements.nativeVideo;
        
        const applyVideoState = () => {
            console.log('üé• –ü—Ä–∏–º–µ–Ω—è—é —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤–∏–¥–µ–æ');
            
            if (data.videoState.isPlaying) {
                console.log(`‚ñ∂Ô∏è –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é play –Ω–∞ ${data.videoState.currentTime}s`);
                applyVideoCommand({
                    action: 'play',
                    time: data.videoState.currentTime
                });
            } else {
                console.log(`‚è∏Ô∏è –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é pause –Ω–∞ ${data.videoState.currentTime}s`);
                applyVideoCommand({
                    action: 'seek',
                    time: data.videoState.currentTime
                });
            }
            
            // –£–¥–∞–ª—è–µ–º —Å–ª—É—à–∞—Ç–µ–ª—å
            video.removeEventListener('loadedmetadata', applyVideoState);
        };
        
        // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ñ–¥–µ–º loadedmetadata –≤–º–µ—Å—Ç–æ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
        if (video.readyState >= 1) { // HAVE_METADATA —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
            // –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã, –≤—ã–ø–æ–ª–Ω—è–µ–º —Å—Ä–∞–∑—É (–Ω–æ –≤ —Å–ª–µ–¥—É—é—â–µ–º —Ç–∏–∫–µ)
            setTimeout(applyVideoState, 100);
        } else {
            // –ñ–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö
            video.addEventListener('loadedmetadata', applyVideoState, { once: true });
            
            // –¢–∞–π–º–∞—É—Ç –∫–∞–∫ –∑–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç - –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –æ–∂–∏–¥–∞–Ω–∏–µ 10 —Å–µ–∫
            setTimeout(() => {
                if (video.readyState >= 1) {
                    applyVideoState();
                }
            }, 10000);
        }
    }
});
        socket.on('participant-joined', (data) => {
            console.log('üë§ –ù–æ–≤—ã–π —É—á–∞—Å—Ç–Ω–∏–∫:', data);
            updateParticipantsList(data.participants);
            elements.onlineCount.textContent = `${data.participants.length} –æ–Ω–ª–∞–π–Ω`;
            addSystemMessage(`${data.message}`);
        });

        socket.on('participant-left', (data) => {
            console.log('üë§ –£—á–∞—Å—Ç–Ω–∏–∫ —É—à–µ–ª:', data);
            updateParticipantsList(data.participants);
            elements.onlineCount.textContent = `${data.participants.length} –æ–Ω–ª–∞–π–Ω`;
            addSystemMessage(`${data.message}`);
        });

        socket.on('leadership-transferred', (data) => {
    console.log('üëë –†–æ–ª—å –ø–µ—Ä–µ–¥–∞–Ω–∞:', data);
    addSystemMessage(`${data.message}`);
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –Ω–∞–º –ª–∏ –ø–µ—Ä–µ–¥–∞–ª–∏ —Ä–æ–ª—å
    if (data.newLeaderId === state.userId) {
        state.isLeader = true;
        elements.loadUrlBtn.disabled = false;
        elements.urlInput.disabled = false;
        addSystemMessage('üé¨ –í–∞–º –ø–µ—Ä–µ–¥–∞–Ω–∞ —Ä–æ–ª—å –í–ï–î–£–©–ï–ì–û!');
        
        // –ï—Å–ª–∏ –≤–∏–¥–µ–æ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤—Å–µ–º
        if (state.currentVideoData) {
            const video = elements.nativeVideo;
            if (video) {
                setTimeout(() => {
                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–∞–∫ –∫–æ–º–∞–Ω–¥—É –æ—Ç –Ω–æ–≤–æ–≥–æ –≤–µ–¥—É—â–µ–≥–æ
                    if (!video.paused) {
                        socket.emit('video-command', {
                            action: 'play',
                            time: video.currentTime
                        });
                    } else {
                        socket.emit('video-command', {
                            action: 'pause',
                            time: video.currentTime
                        });
                    }
                }, 500);
            }
        }
    } else if (state.isLeader) {
        state.isLeader = false;
        elements.loadUrlBtn.disabled = true;
        elements.urlInput.disabled = true;
        addSystemMessage('üì∫ –í—ã –±–æ–ª—å—à–µ –Ω–µ –≤–µ–¥—É—â–∏–π');
    }
});

        socket.on('kicked', (data) => {
            alert(data.reason);
            leaveRoom();
        });

        socket.on('video-sync', (data) => {
            console.log('üé¨ –ö–æ–º–∞–Ω–¥–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:', data);
            
            // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º —Å–≤–æ–∏ –∫–æ–º–∞–Ω–¥—ã
            if (data.leaderId === state.userId) {
                console.log('üîÑ –≠—Ç–æ –º–æ—è –∫–æ–º–∞–Ω–¥–∞ - –∏–≥–Ω–æ—Ä–∏—Ä—É—é');
                return;
            }
            
            // –ï—Å–ª–∏ –≤–µ–¥—É—â–∏–π –∑–∞–≥—Ä—É–∑–∏–ª –Ω–æ–≤–æ–µ –≤–∏–¥–µ–æ ‚Äî –∑–∞–≥—Ä—É–∑–∏—Ç—å —É —Å–µ–±—è
            if (data.action === 'load') {
                addSystemMessage('üé¨ –í–µ–¥—É—â–∏–π –∑–∞–≥—Ä—É–∑–∏–ª: ' + (data.title || data.url));
                processLoadedVideo(data.url, data.title, data.urlFromApi);
                showSyncStatus(true);
                return;
            }

            applyVideoCommand(data);
            showSyncStatus(true);
        });

        // –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ –≤–∏–¥–µ–æ (—É –∑—Ä–∏—Ç–µ–ª–µ–π)
       function processLoadedVideo(url, title, urlFromApi) {
    (async () => {
        let videoData = null;
        
        // –ï—Å–ª–∏ –≤–µ–¥—É—â–∏–π —É–∂–µ –∑–∞–ø—Ä–æ—Å–∏–ª –ø—Ä—è–º—É—é —Å—Å—ã–ª–∫—É —á–µ—Ä–µ–∑ API - –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ—ë
        if (urlFromApi) {
            console.log('‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä—è–º—É—é —Å—Å—ã–ª–∫—É –æ—Ç –≤–µ–¥—É—â–µ–≥–æ');
            const isHls = urlFromApi.includes('.m3u8') || urlFromApi.includes('hls');
            videoData = {
                type: isHls ? 'hls' : 'direct',
                url: urlFromApi,
                title: title || '–í–∏–¥–µ–æ',
                originalUrl: url,
                useProxy: false
            };
            addSystemMessage(`‚úÖ –ó–∞–≥—Ä—É–∂–∞—é: ${videoData.title}`);
        } else {
            // –ò–Ω–∞—á–µ —Å–∞–º–∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–µ–º –∏ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º
            addSystemMessage('üîé –†–∞—Å–ø–æ–∑–Ω–∞—é —Å—Å—ã–ª–∫—É...');
            
            // –ù–û–í–û–ï: –ü—Ä–æ–≤–µ—Ä—è–µ–º –í–ö –≤–∏–¥–µ–æ
            if (url.includes('vkvideo.ru') || url.includes('vk.com/video')) {
                console.log('üì∫ –û–±–Ω–∞—Ä—É–∂–µ–Ω–æ –í–ö –≤–∏–¥–µ–æ');
                try {
                    const resp = await fetch(`${BACKEND_URL}/api/vk`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ url: url })
                    });
                    
                    if (resp.ok) {
                        const json = await resp.json();
                        if (json.type === 'vk-direct') {
                            // –í–ö –≤–∏–¥–µ–æ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
                            videoData = {
                                type: 'vk-direct',
                                url: json.url,
                                title: json.title || title || '–í–ö –≤–∏–¥–µ–æ',
                                originalUrl: url,
                                videoId: json.videoId,
                                looseSync: true  // –ù–û–í–û–ï: –ú—è–≥–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
                            };
                            addSystemMessage(`‚úÖ –í–ö –≤–∏–¥–µ–æ: ${videoData.title}`);
                        } else {
                            // –í–ö embed (iframe)
                            videoData = {
                                type: 'vk-embed',
                                url: json.embedUrl,
                                title: json.title || title || '–í–ö –≤–∏–¥–µ–æ',
                                originalUrl: url,
                                looseSync: true  // –ù–û–í–û–ï: –ú—è–≥–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
                            };
                            addSystemMessage(`‚úÖ –í–ö –≤–∏–¥–µ–æ (embed): ${videoData.title}`);
                        }
                    } else {
                        throw new Error('vk_extract_failed');
                    }
                } catch (e) {
                    console.error('VK extraction failed:', e);
                    addSystemMessage('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –í–ö –≤–∏–¥–µ–æ');
                    return;
                }
            } 
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –º–æ–∂–µ—Ç —ç—Ç–æ –ø—Ä—è–º–∞—è —Å—Å—ã–ª–∫–∞?
            else if (url.match(/\.(mp4|webm|ogg|mov|m3u8)(\?.*)?$/i)) {
                const isHls = url.includes('.m3u8');
                videoData = {
                    type: isHls ? 'hls' : 'direct',
                    url: url,
                    title: title || '–í–∏–¥–µ–æ',
                    originalUrl: url,
                    useProxy: false
                };
                addSystemMessage(`‚úÖ –ü—Ä—è–º–∞—è —Å—Å—ã–ª–∫–∞ –Ω–∞ ${isHls ? 'HLS –ø–æ—Ç–æ–∫' : '–≤–∏–¥–µ–æ'}`);
            } 
            // Rutube
            else if (url.includes('rutube.ru')) {
                try {
                    addSystemMessage('üîÅ –ó–∞–ø—Ä–∞—à–∏–≤–∞—é —É —Å–µ—Ä–≤–µ—Ä–∞ Rutube —Å—Å—ã–ª–∫—É...');
                    const resp = await fetch(`${BACKEND_URL}/api/extract`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ url: url })
                    });
                    
                    if (resp.ok) {
                        const json = await resp.json();
                        
                        // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º relative proxy URL –≤ absolute (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
                        let finalUrl = json.url;
                        if (!finalUrl.startsWith('http') && finalUrl.startsWith('/')) {
                            // –≠—Ç–æ proxy URL –≤—Ä–æ–¥–µ /stream?url=... 
                            // –ù—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å BACKEND_URL
                            finalUrl = BACKEND_URL + finalUrl;
                            console.log(`üì° –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–æ –≤ absolute proxy URL: ${finalUrl.substring(0, 80)}...`);
                        }
                        
                        const isHls = finalUrl.includes('.m3u8') || finalUrl.includes('hls') || json.type === 'hls';
                        const type = json.type ? json.type : (isHls ? 'hls' : 'direct');
                        videoData = {
                            type: type,
                            url: finalUrl,
                            title: json.title || title || 'Rutube –≤–∏–¥–µ–æ',
                            originalUrl: url,
                            useProxy: json.isProxy || false
                        };
                        addSystemMessage(`‚úÖ Rutube —Å—Å—ã–ª–∫–∞ –∏–∑–≤–ª–µ—á–µ–Ω–∞ (${json.isProxy ? '—á–µ—Ä–µ–∑ –ø—Ä–æ–∫—Å–∏' : '–ø—Ä—è–º–∞—è'})`);
                    } else {
                        throw new Error('rutube_extract_failed');
                    }
                } catch (e) {
                    console.error('Rutube extraction failed:', e);
                    addSystemMessage('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ Rutube –≤–∏–¥–µ–æ');
                    return;
                }
            }
            // –î—Ä—É–≥–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏
            else {
                try {
                    addSystemMessage('üîÅ –ó–∞–ø—Ä–∞—à–∏–≤–∞—é —É —Å–µ—Ä–≤–µ—Ä–∞ –ø—Ä—è–º—É—é —Å—Å—ã–ª–∫—É...');
                    const resp = await fetch(`${BACKEND_URL}/api/extract`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ url: url })
                    });
                    
                    if (resp.ok) {
                        const json = await resp.json();
                        
                        // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º relative proxy URL –≤ absolute (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
                        let finalUrl = json.url;
                        if (!finalUrl.startsWith('http') && finalUrl.startsWith('/')) {
                            finalUrl = BACKEND_URL + finalUrl;
                            console.log(`üì° –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–æ –≤ absolute proxy URL: ${finalUrl.substring(0, 80)}...`);
                        }
                        
                        const isHls = finalUrl.includes('.m3u8') || finalUrl.includes('hls') || json.type === 'hls';
                        const type = json.type ? json.type : (isHls ? 'hls' : 'direct');
                        videoData = {
                            type: type,
                            url: finalUrl,
                            title: json.title || title || '–í–∏–¥–µ–æ',
                            originalUrl: url,
                            useProxy: json.isProxy || false
                        };
                        addSystemMessage(`‚úÖ –°—Å—ã–ª–∫–∞ –∏–∑–≤–ª–µ—á–µ–Ω–∞`);
                    } else {
                        const errJson = await resp.json();
                        throw new Error(errJson.error || 'extract_failed');
                    }
                } catch (e) {
                    console.error('Extraction failed:', e);
                    addSystemMessage('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å —Å—Å—ã–ª–∫—É, –ø—Ä–æ–±—É—é –ø—Ä–æ–∫—Å–∏...');
                    // –ü–æ—Å–ª–µ–¥–Ω–∏–π —à–∞–Ω—Å - —á–µ—Ä–µ–∑ –ø—Ä–æ–∫—Å–∏
                    videoData = {
                        type: 'direct',
                        url: url,
                        title: title || '–í–∏–¥–µ–æ',
                        originalUrl: url,
                        useProxy: true
                    };
                }
            }
        }
        
        if (!videoData) {
            addSystemMessage('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –≤–∏–¥–µ–æ');
            return;
        }
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏ —Ä–µ–Ω–¥–µ—Ä–∏–º
        state.currentVideoData = videoData;
        elements.currentVideoTitle.textContent = videoData.title;
        renderVideo(videoData);
        
    })();
}

        socket.on('sync-tick', (data) => {
            // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–æ–≤
            if (!state.isLeader && state.currentVideoData && !state.ignoreNextSync) {
                checkAndCorrectSync(data);
            }
        });

        socket.on('sync-response', (data) => {
    // –ü–æ–ª—É—á–∏–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å–∏–Ω—Ö—Ä–æ –∑–∞–ø—Ä–æ—Å–∞
    console.log(`üîÑ –ü–æ–ª—É—á–µ–Ω sync-response: –æ–∂–∏–¥–∞–µ–º–æ–µ –≤—Ä–µ–º—è ${data.expectedTime.toFixed(1)}—Å`);
    
    if (!state.currentVideoData) {
        console.log('‚è≠Ô∏è –í–∏–¥–µ–æ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ, –∏–≥–Ω–æ—Ä–∏—Ä—É—é');
        return;
    }
    
    const video = elements.nativeVideo;
    if (!video) return;
    
    const currentTime = video.currentTime;
    const diff = Math.abs(currentTime - data.expectedTime);
    
    if (diff > 1.5) { // –†–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω –±–æ–ª—å—à–µ 1.5 —Å–µ–∫—É–Ω–¥
        console.log(`‚ö†Ô∏è –†–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω: —Ç–µ–∫—É—â–µ–µ ${currentTime.toFixed(1)}—Å, –æ–∂–∏–¥–∞–µ–º–æ–µ ${data.expectedTime.toFixed(1)}—Å (—Ä–∞–∑–Ω–∏—Ü–∞ ${diff.toFixed(1)}—Å)`);
        addSystemMessage(`üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è... (${diff.toFixed(1)}—Å)`);
        gentleSync(data.expectedTime);
        showSyncStatus(true);
    } else {
        console.log(`‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤ –Ω–æ—Ä–º–µ (—Ä–∞–∑–Ω–∏—Ü–∞ ${diff.toFixed(1)}—Å)`);
    }
});

        // –ù–û–í–û–ï: –°–ª—É—à–∞—Ç–µ–ª—å –¥–ª—è heartbeat –º—è–≥–∫–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ (–í–ö –≤–∏–¥–µ–æ)
        socket.on('embed-video-heartbeat', (data) => {
            if (!state.currentVideoData || !state.currentVideoData.looseSync) {
                return; // –ù–µ –Ω–∞—à–µ –≤–∏–¥–µ–æ –∏–ª–∏ –Ω–µ embed
            }
            
            if (state.isLeader) {
                return; // –í–µ–¥—É—â–∏–π –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–≤–æ–∏ heartbeats
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ heartbeat
            state.lastEmbedHeartbeat = Date.now();
            
            console.log(`üíì –ü–æ–ª—É—á–µ–Ω heartbeat –æ—Ç –≤–µ–¥—É—â–µ–≥–æ (–í–ö –≤–∏–¥–µ–æ —Å–∏–Ω—Ö—Ä–æ)`);
            
            // –û—á–∏—â–∞–µ–º —Ç–∞–π–º–∞—É—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏
            if (state.embedHeartbeatTimeout) {
                clearTimeout(state.embedHeartbeatTimeout);
            }
            
            // –ü–µ—Ä–µ—É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–≤—ã–π —Ç–∞–π–º–∞—É—Ç
            state.embedHeartbeatTimeout = setTimeout(() => {
                if (state.currentVideoData && state.currentVideoData.looseSync) {
                    console.log('‚ö†Ô∏è Heartbeat timeout - –ø–æ—Ç–µ—Ä—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å –≤–µ–¥—É—â–∏–º');
                    addSystemMessage('‚ùå –ü–æ—Ç–µ—Ä—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å –≤–µ–¥—É—â–∏–º (–í–ö –≤–∏–¥–µ–æ)');
                }
            }, 20000);
        });

        socket.on('chat-message', (data) => {
            addChatMessage(data.username, data.message, false);
            // Desktop notification –∏ –∑–≤—É–∫ –ø—Ä–∏ —Å–∫—Ä—ã—Ç–æ–π –≤–∫–ª–∞–¥–∫–µ
            try {
                notifyNewMessage(data.username, data.message);
            } catch (e) { /* noop */ }
        });

        // –ó–∞–ø—Ä–æ—Å –ø—Ä–∞–≤ –Ω–∞ –Ω–æ—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∑–≤—É–∫–∞ (Web Audio API)
        function playNotificationSound() {
            try {
                const Ctx = window.AudioContext || window.webkitAudioContext;
                if (!Ctx) return;
                const ctx = new Ctx();
                const o = ctx.createOscillator();
                const g = ctx.createGain();
                o.type = 'sine';
                o.frequency.value = 1000;
                g.gain.value = 0.0001;
                o.connect(g);
                g.connect(ctx.destination);
                o.start();
                g.gain.exponentialRampToValueAtTime(0.08, ctx.currentTime + 0.01);
                g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.2);
                o.stop(ctx.currentTime + 0.21);
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–∑–∂–µ
                setTimeout(() => { try { ctx.close(); } catch (e) {} }, 500);
            } catch (e) { /* noop */ }
        }

        function notifyNewMessage(from, text) {
            // –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ –∑–≤—É–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
            playNotificationSound();

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–æ—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é, –µ—Å–ª–∏ –≤–∫–ª–∞–¥–∫–∞ –Ω–µ–∞–∫—Ç–∏–≤–Ω–∞
            if (document.hidden && window.Notification && Notification.permission === 'granted') {
                new Notification(from, { body: text });
            } else if (window.Notification && Notification.permission !== 'denied') {
                // –ó–∞–ø—Ä–æ—Å–∏—Ç—å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted' && document.hidden) {
                        new Notification(from, { body: text });
                    }
                });
            }
        }

        socket.on('error', (data) => {
            console.error('‚ùå –û—à–∏–±–∫–∞:', data.message);
            alert('–û—à–∏–±–∫–∞: ' + data.message);
        });

        // ==================== –£–ü–†–ê–í–õ–ï–ù–ò–ï –ö–û–ú–ù–ê–¢–û–ô ====================
        function createRoom() {
            socket.emit('join-room', {
                roomId: 'room_' + Math.random().toString(36).substr(2, 6).toUpperCase(),
                username: state.username
            });
        }

        function joinRoom(roomId) {
            socket.emit('join-room', {
                roomId: roomId,
                username: state.username
            });
        }

        function handleJoinRoomSuccess(roomId) {
            state.roomId = roomId;
            elements.currentRoomId.textContent = roomId;
            elements.roomInfo.style.display = 'flex';
            
            elements.createRoomBtn.disabled = true;
            elements.joinRoomBtn.disabled = true;
            elements.roomIdInput.disabled = true;
            elements.leaveRoomBtn.style.display = 'inline-block';
            elements.chatInput.disabled = false;
            elements.sendMessageBtn.disabled = false;
            
            elements.roomIdInput.value = '';
        }

        function leaveRoom() {
            if (!state.roomId) return;
            
            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞
            if (state.currentVideoData) {
                const video = state.currentVideoData.type === 'direct' ? elements.nativeVideo : null;
                if (video) {
                    video.pause();
                    video.src = '';
                }
            }
            
            state.roomId = null;
            state.isLeader = false;
            state.currentVideoData = null;
            
            elements.roomInfo.style.display = 'none';
            elements.createRoomBtn.disabled = false;
            elements.joinRoomBtn.disabled = false;
            elements.roomIdInput.disabled = false;
            elements.leaveRoomBtn.style.display = 'none';
            elements.chatInput.disabled = true;
            elements.sendMessageBtn.disabled = true;
            elements.loadUrlBtn.disabled = true;
            elements.urlInput.disabled = true;
            
            elements.nativeVideo.pause();
            elements.nativeVideo.src = '';
            elements.videoPlayer.src = '';
            elements.nativeVideo.style.display = 'none';
            elements.videoPlayer.style.display = 'block';
            elements.currentVideoTitle.textContent = '–í—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ –≤–∏–¥–µ–æ';
            
            addSystemMessage('üëã –í—ã –ø–æ–∫–∏–Ω—É–ª–∏ –∫–æ–º–Ω–∞—Ç—É');
        }

        function updateParticipantsList(participants) {
            elements.participantsList.innerHTML = '';
            participants.forEach(p => {
                const badge = document.createElement('div');
                badge.className = `user-badge ${p.role === 'leader' ? 'host' : ''}`;
                badge.innerHTML = `
                    <i class="${p.role === 'leader' ? 'fas fa-crown' : 'fas fa-user'}"></i>
                    <span>${p.username}</span>
                    ${p.role === 'leader' ? '<span class="role-badge">–í–ï–î–£–©–ò–ô</span>' : ''}
                `;
                elements.participantsList.appendChild(badge);
            });
        }

        // ==================== –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø –í–ò–î–ï–û ====================
        function parseVideoUrl(url) {
            try {
                const urlLower = url.toLowerCase().trim();
                
                // –ü—Ä—è–º—ã–µ –≤–∏–¥–µ–æ —Ñ–∞–π–ª—ã
                if (urlLower.match(/\.(mp4|webm|ogg|mov|avi|mkv|flv|m3u8)$/i)) {
                    return {
                        type: 'direct',
                        url: url,
                        title: '–í–∏–¥–µ–æ'
                    };
                }
                
                // YouTube, Vimeo –∏ —Ç.–¥. - —Ç—Ä–µ–±—É—é—Ç yt-dlp
                if (urlLower.includes('youtube.com') || urlLower.includes('youtu.be') ||
                    urlLower.includes('vimeo.com') || urlLower.includes('dailymotion.com') ||
                    urlLower.includes('twitch.tv') || urlLower.includes('rutube.ru') ||
                    urlLower.includes('vk.com') || urlLower.includes('vkontakte.ru')) {
                    return {
                        type: 'embed',  // –¢—Ä–µ–±—É–µ—Ç—Å—è yt-dlp –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä—è–º–æ–π —Å—Å—ã–ª–∫–∏
                        url: url,
                        title: '–í–∏–¥–µ–æ'
                    };
                }
                
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ URL:', e);
            }
            
            return null;
        }

        function loadVideo(url) {
            if (!state.isLeader) {
                alert('–¢–æ–ª—å–∫–æ –≤–µ–¥—É—â–∏–π –º–æ–∂–µ—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å –≤–∏–¥–µ–æ!');
                return;
            }
            
            (async () => {
                addSystemMessage('üîé –ü—ã—Ç–∞—é—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å —Å—Å—ã–ª–∫—É...');
                let videoData = null;
                let useDirectLink = false;
                
                // –ù–û–í–û–ï: –ü—Ä–æ–≤–µ—Ä—è–µ–º –í–ö –≤–∏–¥–µ–æ
                if (url.includes('vkvideo.ru') || url.includes('vk.com/video')) {
                    console.log('üì∫ –û–±–Ω–∞—Ä—É–∂–µ–Ω–æ –í–ö –≤–∏–¥–µ–æ');
                    try {
                        const resp = await fetch(`${BACKEND_URL}/api/vk`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ url: url })
                        });
                        
                        if (resp.ok) {
                            const json = await resp.json();
                            videoData = {
                                type: json.type, // 'vk-direct' –∏–ª–∏ 'vk-embed'
                                url: url,
                                title: json.title || '–í–ö –≤–∏–¥–µ–æ',
                                originalUrl: url,
                                videoId: json.videoId
                            };
                            addSystemMessage(`‚úÖ –í–ö –≤–∏–¥–µ–æ: ${videoData.title}`);
                        } else {
                            throw new Error('vk_extract_failed');
                        }
                    } catch (e) {
                        console.error('VK extraction failed:', e);
                        addSystemMessage('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –í–ö –≤–∏–¥–µ–æ');
                        return;
                    }
                }
                // –í—Å–µ –≤–∏–¥–µ–æ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä—è–º–æ–π —Å—Å—ã–ª–∫–∏
                else if (!videoData || videoData.type === 'embed') {
                    try {
                        addSystemMessage('üîÅ –ó–∞–ø—Ä–∞—à–∏–≤–∞—é —É —Å–µ—Ä–≤–µ—Ä–∞ –ø—Ä—è–º—É—é —Å—Å—ã–ª–∫—É...');
                        const resp = await fetch(`${BACKEND_URL}/api/extract`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ url })
                        });
                        if (resp.ok) {
                            const json = await resp.json();
                            
                            // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º relative proxy URL –≤ absolute (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
                            let finalUrl = json.url;
                            if (!finalUrl.startsWith('http') && finalUrl.startsWith('/')) {
                                finalUrl = BACKEND_URL + finalUrl;
                                console.log(`üì° –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–æ –≤ absolute proxy URL: ${finalUrl.substring(0, 80)}...`);
                            }
                            
                            const isHls = finalUrl.includes('.m3u8') || finalUrl.includes('hls') || json.type === 'hls';
                            // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–∏–ø –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞ –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω
                            const type = json.type ? json.type : (isHls ? 'hls' : 'direct');
                            videoData = {
                                type: type,
                                url: finalUrl,
                                title: json.title || '–í–∏–¥–µ–æ',
                                originalUrl: url,
                                useProxy: json.isProxy || false
                            };
                            addSystemMessage('‚úÖ –°—Å—ã–ª–∫–∞ –∏–∑–≤–ª–µ—á–µ–Ω–∞');
                            useDirectLink = true;
                        } else {
                            throw new Error('extract_failed');
                        }
                    } catch (e) {
                        console.error('Extraction failed', e);
                        addSystemMessage('‚ö†Ô∏è –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–æ, –±—É–¥—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–æ–∫—Å–∏ –ø—Ä–∏ –æ—à–∏–±–∫–µ');
                        videoData = {
                            type: 'embed',
                            url: url,
                            title: '–í–∏–¥–µ–æ',
                            originalUrl: url,
                            useProxy: true,
                            proxyOn: false
                        };
                    }
                } else if (videoData.type === 'direct') {
                    // –ü—Ä—è–º–∞—è —Å—Å—ã–ª–∫–∞ –Ω–∞ —Ñ–∞–π–ª - –∏—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞–ø—Ä—è–º—É—é
                    addSystemMessage('‚úÖ –ü—Ä—è–º–∞—è —Å—Å—ã–ª–∫–∞ –Ω–∞ —Ñ–∞–π–ª');
                    useDirectLink = true;
                }
                
                if (!videoData) {
                    addSystemMessage('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è —Å–æ —Å—Å—ã–ª–∫–µ');
                    alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å –≤–∏–¥–µ–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø—Ä—è–º—É—é —Å—Å—ã–ª–∫—É MP4.');
                    return;
                }
                
                state.currentVideoData = videoData;
                elements.currentVideoTitle.textContent = videoData.title;
                
                // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ò–°–•–û–î–ù–´–ô URL –∑—Ä–∏—Ç–µ–ª—è–º, –∞ –Ω–µ –≤—Ä–µ–º–µ–Ω–Ω—É—é —Å—Å—ã–ª–∫—É!
                // –ó—Ä–∏—Ç–µ–ª–∏ —Å–∞–º–∏ –∑–∞–ø—Ä–æ—Å—è—Ç –ø—Ä—è–º—É—é —Å—Å—ã–ª–∫—É —á–µ—Ä–µ–∑ API
                socket.emit('video-command', {
                    action: 'load',
                    url: url,  // –ò–°–•–û–î–ù–´–ô URL (YouTube, Rutube –∏ —Ç.–¥.)
                    originalUrl: url,
                    urlFromApi: useDirectLink ? videoData.url : null,  // –ï—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å –ø—Ä—è–º–∞—è - –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º
                    title: videoData.title,
                    type: videoData.type
                });
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –ª–æ–∫–∞–ª—å–Ω–æ
                renderVideo(videoData);
                
                elements.urlInput.value = '';
                addSystemMessage(`üé¨ –í–ï–î–£–©–ò–ô –∑–∞–≥—Ä—É–∑–∏–ª: ${videoData.title}`);
            })();
        }

        function renderVideo(videoData) {
            // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ –≤–∏–¥–µ–æ
            elements.nativeVideo.style.display = 'none';
            elements.videoPlayer.style.display = 'none';
            elements.videoPlayer.src = '';
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º HLS —ç–∫–∑–µ–º–ø–ª—è—Ä –µ—Å–ª–∏ –µ—Å—Ç—å
            if (window.currentHls) {
                try {
                    window.currentHls.destroy();
                } catch (e) {}
                window.currentHls = null;
            }
            
            // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ embed —ç–ª–µ–º–µ–Ω—Ç—ã
            const oldEmbeds = document.querySelectorAll('.embed-player-wrapper');
            oldEmbeds.forEach(el => el.remove());
            
            // –ù–û–í–û–ï: –û–±—Ä–∞–±–æ—Ç–∫–∞ Rutube –≤–∏–¥–µ–æ
            if (videoData.type === 'rutube-embed') {
                console.log('üì∫ Rutube –≤–∏–¥–µ–æ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ - –≤—Å—Ç—Ä–∞–∏–≤–∞—é –ø–ª–µ–µ—Ä Rutube');
                
                elements.nativeVideo.style.display = 'none';
                elements.videoPlayer.style.display = 'none';
                
                const playerWrapper = document.getElementById('playerWrapper');
                
                // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è Rutube embed
                const embedWrapper = document.createElement('div');
                embedWrapper.className = 'embed-player-wrapper';
                embedWrapper.style.cssText = `
                    width: 100%;
                    height: 100%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    background: #000;
                `;
                
                // Rutube embed iframe
                const iframeUrl = videoData.playerUrl || `https://rutube.ru/play/embed/${videoData.videoId}`;
                embedWrapper.innerHTML = `
                    <iframe 
                        width="100%" 
                        height="100%" 
                        src="${iframeUrl}" 
                        frameborder="0" 
                        allow="clipboard-write; encrypted-media; fullscreen; picture-in-picture" 
                        allowfullscreen 
                        style="border: none; display: block; max-width: 100%; box-sizing: border-box;"
                    ></iframe>
                `;
                
                playerWrapper.innerHTML = '';
                playerWrapper.appendChild(embedWrapper);
                
                addSystemMessage(`üé¨ Rutube: ${videoData.title}`);
                addSystemMessage(`üíì –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è: ¬±30 —Å–µ–∫ (Play/Pause/Seek)`);
                
                // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é –¥–ª—è embed –≤–∏–¥–µ–æ
                setupLooseSyncForEmbed();
                return;
            }
            
            // –ù–û–í–û–ï: –û–±—Ä–∞–±–æ—Ç–∫–∞ VK –≤–∏–¥–µ–æ
            if (videoData.type === 'vk-embed') {
                console.log('üì∫ VK –≤–∏–¥–µ–æ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ - –≤—Å—Ç—Ä–∞–∏–≤–∞—é –ø–ª–µ–µ—Ä VK');
                
                elements.nativeVideo.style.display = 'none';
                elements.videoPlayer.style.display = 'none';
                
                const playerWrapper = document.getElementById('playerWrapper');
                
                // –ü—ã—Ç–∞–µ–º—Å—è –≤—Å—Ç—Ä–æ–∏—Ç—å VK –ø–ª–µ–µ—Ä (–º–æ–∂–µ—Ç –±—ã—Ç—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ X-Frame-Options)
                const embedWrapper = document.createElement('div');
                embedWrapper.className = 'embed-player-wrapper';
                embedWrapper.style.cssText = `
                    width: 100%;
                    height: 100%;
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    background: linear-gradient(135deg, #4a90e2 0%, #357abd 100%);
                `;
                
                // –°–æ–∑–¥–∞–µ–º iframe –¥–ª—è VK 
                const embedDiv = document.createElement('div');
                embedDiv.id = 'vkEmbedContainer';
                embedDiv.style.cssText = `
                    width: 100%;
                    height: 100%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                `;
                
                // VK Video iframe
                const vkIframe = document.createElement('iframe');
                vkIframe.src = `https://vkvideo.ru/embed/${videoData.videoId}`;
                vkIframe.style.cssText = `
                    width: 100%;
                    height: 100%;
                    border: none;
                    display: none;
                `;
                vkIframe.frameborder = '0';
                vkIframe.allowFullscreen = true;
                vkIframe.id = 'vkVideoIframe';
                
                embedDiv.appendChild(vkIframe);
                embedWrapper.appendChild(embedDiv);
                
                // –§–æ–ª–ª–±—ç–∫ –µ—Å–ª–∏ iframe –Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è (VK –±–ª–æ–∫–∏—Ä—É–µ—Ç X-Frame-Options)
                const fallbackDiv = document.createElement('div');
                fallbackDiv.style.cssText = `
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    width: 100%;
                    height: 100%;
                    color: white;
                    padding: 40px;
                    text-align: center;
                    box-sizing: border-box;
                `;
                
                fallbackDiv.innerHTML = `
                    <div style="font-size: 48px; margin-bottom: 20px;">üé¨</div>
                    <h2 style="margin: 0 0 10px 0;">–ü–ª–µ–µ—Ä VK</h2>
                    <p style="margin: 0 0 20px 0; opacity: 0.9; max-width: 400px;">${videoData.title || '–í–∏–¥–µ–æ'}</p>
                    <p style="margin: 0 0 30px 0; opacity: 0.8; font-size: 14px;">
                        ‚ö†Ô∏è –ë—Ä–∞—É–∑–µ—Ä –±–ª–æ–∫–∏—Ä—É–µ—Ç –≤—Å—Ç—Ä–∞–∏–≤–∞–Ω–∏–µ –ø–ª–µ–µ—Ä–∞ VK<br/>
                        –û—Ç–∫—Ä–æ–π—Ç–µ –≤–∏–¥–µ–æ –≤ –Ω–æ–≤–æ–º –æ–∫–Ω–µ
                    </p>
                    <button id="openVkBtn" style="
                        padding: 12px 32px;
                        font-size: 16px;
                        font-weight: bold;
                        background: white;
                        color: #4a90e2;
                        border: none;
                        border-radius: 6px;
                        cursor: pointer;
                        transition: all 0.3s;
                    ">
                        üîó –û—Ç–∫—Ä—ã—Ç—å –≤ –Ω–æ–≤–æ–º –æ–∫–Ω–µ
                    </button>
                `;
                
                embedWrapper.appendChild(fallbackDiv);
                
                playerWrapper.innerHTML = '';
                playerWrapper.appendChild(embedWrapper);
                
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ —Ñ–æ–ª–ª–±—ç–∫–∞
                setTimeout(() => {
                    const btn = document.getElementById('openVkBtn');
                    if (btn) {
                        btn.addEventListener('click', () => {
                            window.open(videoData.url, 'vk_video', 'width=960,height=720');
                        });
                    }
                }, 0);
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –ª–∏ iframe - –µ—Å–ª–∏ –Ω–µ—Ç, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ–ª–ª–±—ç–∫
                setTimeout(() => {
                    const iframe = document.getElementById('vkVideoIframe');
                    if (iframe && iframe.offsetHeight === 0) {
                        iframe.style.display = 'none';
                        fallbackDiv.style.display = 'flex';
                    } else if (iframe) {
                        iframe.style.display = 'block';
                        fallbackDiv.style.display = 'none';
                    }
                }, 2000);
                
                addSystemMessage(`üé¨ VK: ${videoData.title}`);
                addSystemMessage(`üíì –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è: ¬±30 —Å–µ–∫ (Play/Pause)`);
                
                // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é
                setupLooseSyncForEmbed();
                return;
            }
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä—è–º–æ–≥–æ –ú–ü4 –≤–∏–¥–µ–æ
            if (videoData.type === 'direct') {
                elements.nativeVideo.style.display = 'block';
                elements.nativeVideo.src = videoData.url;
                elements.nativeVideo.dataset.originalUrl = videoData.originalUrl || videoData.url;
                
                try {
                    elements.nativeVideo.load();
                    addSystemMessage('üìπ –ó–∞–≥—Ä—É–∂–∞—é –≤–∏–¥–µ–æ...');
                } catch (e) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–µ–æ:', e);
                    addSystemMessage('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–µ–æ: ' + e.message);
                }
                
                elements.nativeVideo.addEventListener('loadedmetadata', () => {
                    console.log('‚úÖ –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –≤–∏–¥–µ–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã');
                    addSystemMessage(`‚úÖ –í–∏–¥–µ–æ –≥–æ—Ç–æ–≤–æ (${(elements.nativeVideo.duration || 0).toFixed(0)}s)`);
                    setupVideoListeners();
                }, { once: true });
                
                return;
            }
        }

        function setupLooseSyncForEmbed() {
            // –ù–û–í–û–ï: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ sync –¥–ª—è embed –≤–∏–¥–µ–æ (Rutube, VK, YouTube)
            // –ú—ã —Å–æ–∑–¥–∞–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä —Å play/pause/seek –¥–ª—è –≤–æ–∂–¥–µ–Ω–∏—è
            
            console.log('üéØ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–µ–π –¥–ª—è embed –≤–∏–¥–µ–æ');
            
            // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä UI
            let controllerDiv = document.getElementById('embedSyncController');
            if (!controllerDiv) {
                controllerDiv = document.createElement('div');
                controllerDiv.id = 'embedSyncController';
                document.getElementById('playerWrapper').appendChild(controllerDiv);
            }
            
            // –°—Ç–∏–ª–∏ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞
            controllerDiv.style.cssText = `
                position: absolute;
                bottom: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: rgba(0, 0, 0, 0.85);
                backdrop-filter: blur(10px);
                padding: 15px 25px;
                border-radius: 50px;
                display: flex;
                gap: 12px;
                align-items: center;
                z-index: 1000;
                color: white;
                font-size: 14px;
                box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
            `;
            
            // –°–æ—Å—Ç–æ—è–Ω–∏–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –≤–∏–¥–µ–æ
            const embedState = {
                isPlaying: false,
                currentTime: 0,
                duration: 0,
                updateTime: Date.now()
            };
            
            if (state.isLeader) {
                // –í–ï–î–£–©–ò–ô: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
                controllerDiv.innerHTML = `
                    <button id="embedPlayBtn" style="
                        background: #4CAF50;
                        color: white;
                        border: none;
                        padding: 8px 14px;
                        border-radius: 20px;
                        cursor: pointer;
                        font-size: 14px;
                        font-weight: bold;
                        transition: all 0.3s;
                    ">‚ñ∂Ô∏è Play</button>
                    
                    <button id="embedPauseBtn" style="
                        background: #f44336;
                        color: white;
                        border: none;
                        padding: 8px 14px;
                        border-radius: 20px;
                        cursor: pointer;
                        font-size: 14px;
                        font-weight: bold;
                        transition: all 0.3s;
                    ">‚è∏Ô∏è Pause</button>
                    
                    <span id="embedTime" style="
                        margin-left: 10px;
                        min-width: 80px;
                        text-align: center;
                        font-size: 12px;
                        opacity: 0.8;
                    ">–í—Ä–µ–º—è: -:--</span>
                `;
                
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫
                document.getElementById('embedPlayBtn').addEventListener('click', () => {
                    embedState.isPlaying = true;
                    embedState.updateTime = Date.now();
                    
                    console.log('‚ñ∂Ô∏è –í–ï–î–£–©–ò–ô –Ω–∞–∂–∞–ª PLAY');
                    socket.emit('video-command', {
                        action: 'play',
                        videoType: state.currentVideoData.type,
                        time: embedState.currentTime
                    });
                    
                    addSystemMessage('‚ñ∂Ô∏è –í–ï–î–£–©–ò–ô: Play');
                });
                
                document.getElementById('embedPauseBtn').addEventListener('click', () => {
                    embedState.isPlaying = false;
                    
                    console.log('‚è∏Ô∏è –í–ï–î–£–©–ò–ô –Ω–∞–∂–∞–ª PAUSE');
                    socket.emit('video-command', {
                        action: 'pause',
                        videoType: state.currentVideoData.type,
                        time: embedState.currentTime
                    });
                    
                    addSystemMessage('‚è∏Ô∏è –í–ï–î–£–©–ò–ô: Pause');
                });
                
                // –≠–º—É–ª–∏—Ä—É–µ–º –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –≤–∏–¥–µ–æ
                const syncLoop = setInterval(() => {
                    if (!state.isLeader || !state.roomId) {
                        clearInterval(syncLoop);
                        return;
                    }
                    
                    if (embedState.isPlaying) {
                        const elapsed = (Date.now() - embedState.updateTime) / 1000;
                        embedState.currentTime += elapsed;
                        embedState.updateTime = Date.now();
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏
                    const mins = Math.floor(embedState.currentTime / 60);
                    const secs = Math.floor(embedState.currentTime % 60);
                    const timeStr = `${mins}:${secs < 10 ? '0' : ''}${secs}`;
                    
                    const timeEl = document.getElementById('embedTime');
                    if (timeEl) {
                        timeEl.textContent = `–í—Ä–µ–º—è: ${timeStr}`;
                        timeEl.style.color = embedState.isPlaying ? '#4CAF50' : '#f44336';
                    }
                    
                    // –ö–∞–∂–¥—ã–µ 5 —Å–µ–∫ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º heartbeat —Å —Ç–µ–∫—É—â–∏–º –≤—Ä–µ–º–µ–Ω–µ–º
                    if (Math.floor(embedState.currentTime) % 5 === 0 && Math.floor(embedState.currentTime) !== (embedState.lastHeartbeatTime || -1)) {
                        embedState.lastHeartbeatTime = Math.floor(embedState.currentTime);
                        
                        socket.emit('embed-sync-status', {
                            roomId: state.roomId,
                            videoType: state.currentVideoData.type,
                            isPlaying: embedState.isPlaying,
                            currentTime: embedState.currentTime
                        });
                    }
                }, 500);
                
                addSystemMessage('üéÆ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–∏–¥–µ–æ: –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ Play/Pause');
                
            } else {
                // –ó–†–ò–¢–ï–õ–¨: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å –æ—Ç –≤–µ–¥—É—â–µ–≥–æ
                controllerDiv.innerHTML = `
                    <span id="embedSyncStatus" style="
                        font-size: 14px;
                        display: flex;
                        gap: 8px;
                        align-items: center;
                    ">
                        <span id="playStatus">‚è∏Ô∏è –ü–∞—É–∑–∞</span>
                        <span id="timeStatus" style="opacity: 0.7;">-:--</span>
                    </span>
                    <span style="opacity: 0.5;">|</span>
                    <span style="font-size: 12px; opacity: 0.7;">üíì –°–∏–Ω—Ö—Ä–æ: ¬±30 —Å–µ–∫</span>
                `;
                
                // –°–ª—É—à–∞–µ–º –∫–æ–º–∞–Ω–¥—ã –æ—Ç –≤–µ–¥—É—â–µ–≥–æ
                socket.on('embed-sync-status', (data) => {
                    if (data.roomId !== state.roomId) return;
                    
                    const statusEl = document.getElementById('playStatus');
                    const timeEl = document.getElementById('timeStatus');
                    
                    if (statusEl) {
                        statusEl.textContent = data.isPlaying ? '‚ñ∂Ô∏è –ò–≥—Ä–∞–µ—Ç' : '‚è∏Ô∏è –ü–∞—É–∑–∞';
                        statusEl.style.color = data.isPlaying ? '#4CAF50' : '#f44336';
                    }
                    
                    if (timeEl && data.currentTime !== undefined) {
                        const mins = Math.floor(data.currentTime / 60);
                        const secs = Math.floor(data.currentTime % 60);
                        timeEl.textContent = `${mins}:${secs < 10 ? '0' : ''}${secs}`;
                    }
                    
                    console.log('üì° –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –≤–∏–¥–µ–æ –æ—Ç –≤–µ–¥—É—â–µ–≥–æ:', data);
                });
                
                addSystemMessage('üëÅÔ∏è –°–∏–Ω—Ö—Ä–æ –≤–∫–ª: –≤–µ–¥—É—â–∏–π —É–ø—Ä–∞–≤–ª—è–µ—Ç –≤–∏–¥–µ–æ (¬±30 —Å–µ–∫)');
            }
        }

        function setupVideoListeners() {
            if (!elements.nativeVideo) return;
            
            const video = elements.nativeVideo;
            
            // –ï—Å–ª–∏ –ø—Ä–∏ –ø—Ä—è–º–æ–º –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–∏ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞, –ø—Ä–æ–±—É–µ–º –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞—Ç—å
            video.addEventListener('error', (e) => {
                try {
                    const tried = video.dataset.proxyTried === 'true';
                    const orig = video.dataset.originalSrc;
                    if (!tried && orig) {
                        console.warn('Direct playback failed, switching to proxy...');
                        video.dataset.proxyTried = 'true';
                        const proxyUrl = `${BACKEND_URL}/stream?url=` + encodeURIComponent(orig);
                        video.src = proxyUrl;
                        video.load();
                        video.play().catch(()=>{});
                    }
                } catch (err) { console.error(err); }
            });
            
            video.addEventListener('play', () => {
                if (!state.isLeader || state.ignoreNextSync) {
                    state.ignoreNextSync = false;
                    return;
                }
                
                if (!state.roomId) return;
                
                console.log('‚ñ∂Ô∏è –í–ï–î–£–©–ò–ô –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç play');
                socket.emit('video-command', {
                    action: 'play',
                    time: video.currentTime
                });
            });
            
            video.addEventListener('pause', () => {
                if (!state.isLeader || state.ignoreNextSync) {
                    state.ignoreNextSync = false;
                    return;
                }
                
                if (!state.roomId) return;
                
                console.log('‚è∏Ô∏è –í–ï–î–£–©–ò–ô –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç pause');
                socket.emit('video-command', {
                    action: 'pause',
                    time: video.currentTime
                });
            });
            
            // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –û—Ç–ø—Ä–∞–≤–ª—è–µ–º seek –ù–ï–ú–ï–î–õ–ï–ù–ù–û, –Ω–µ –∂–¥–µ–º 300ms
            video.addEventListener('seeked', () => {
                if (!state.isLeader || state.ignoreNextSync) {
                    state.ignoreNextSync = false;
                    return;
                }
                
                if (!state.roomId) return;
                
                // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –°–†–ê–ó–£ –ë–ï–ó –ó–ê–î–ï–†–ñ–ö–ò
                console.log(`‚è™ –í–ï–î–£–©–ò–ô –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç seek –Ω–∞ ${video.currentTime.toFixed(1)}s`);
                socket.emit('video-command', {
                    action: 'seek',
                    time: video.currentTime
                });
            });
            
            // –ù–û–í–û–ï: –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É 'seeking' —Å–æ–±—ã—Ç–∏—è –¥–ª—è —Ä–∞–Ω–Ω–µ–π –æ—Ç–ø—Ä–∞–≤–∫–∏
            video.addEventListener('seeking', () => {
                if (!state.isLeader) return;
                if (!state.roomId) return;
                
                console.log(`‚è™ –í–ï–î–£–©–ò–ô –Ω–∞—á–∞–ª –ø–µ—Ä–µ–º–æ—Ç–∫—É –Ω–∞ ${video.currentTime.toFixed(1)}s (seeking)`);
            });
        }

  function applyVideoCommand(data) {
    const video = elements.nativeVideo;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤–∏–¥–µ–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è
    if (!video || !state.currentVideoData) {
        console.log('‚ö†Ô∏è –ö–æ–º–∞–Ω–¥–∞ –≤–∏–¥–µ–æ –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∞ - –≤–∏–¥–µ–æ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ');
        return;
    }
    
    // –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º —Ç–æ–ª—å–∫–æ direct –∏ hls —Ç–∏–ø—ã
    if (state.currentVideoData.type !== 'direct' && state.currentVideoData.type !== 'hls') {
        console.log('‚ö†Ô∏è –ö–æ–º–∞–Ω–¥–∞ –≤–∏–¥–µ–æ –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∞ - —Ç–∏–ø –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é:', state.currentVideoData.type);
        return;
    }
    
    state.ignoreNextSync = true;
    
    console.log(`üé¨ –ü—Ä–∏–º–µ–Ω—è—é –∫–æ–º–∞–Ω–¥—É: ${data.action} –Ω–∞ –≤—Ä–µ–º—è ${data.time?.toFixed(2) || 'N/A'}`);
    
    // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –≤–∏–¥–µ–æ
    const isVideoReady = () => {
        return video.readyState >= 2; // HAVE_CURRENT_DATA - –º–æ–∂–Ω–æ –º–µ–Ω—è—Ç—å currentTime –∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—å
    };
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã —Å —É—á–µ—Ç–æ–º –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –≤–∏–¥–µ–æ
    const executeCommand = () => {
        try {
            console.log(`üìπ –í—ã–ø–æ–ª–Ω—è—é –∫–æ–º–∞–Ω–¥—É: ${data.action}, readyState=${video.readyState}`);
            
            switch (data.action) {
                case 'play':
                    // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Ä–µ–º—è –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –≤–∏–¥–µ–æ –≥–æ—Ç–æ–≤–æ
                    if (typeof data.time === 'number') {
                        video.currentTime = data.time;
                        console.log(`‚è±Ô∏è –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –≤—Ä–µ–º—è: ${data.time.toFixed(2)}s`);
                    }
                    
                    // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: play() –º–æ–∂–µ—Ç –≤—ã–±—Ä–æ—Å–∏—Ç—å –æ—à–∏–±–∫—É, –ª–æ–≤–∏–º –µ—ë
                    const playPromise = video.play();
                    if (playPromise !== undefined) {
                        playPromise.catch(e => {
                            console.error('‚ùå –û—à–∏–±–∫–∞ play():', e.name, e.message);
                            // –ï—Å–ª–∏ –∞–≤—Ç–æ–≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ - –æ–±—ã—á–Ω–æ
                            if (e.name === 'NotAllowedError') {
                                addSystemMessage('‚ö†Ô∏è –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –≤–∏–¥–µ–æ –¥–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è (–±—Ä–∞—É–∑–µ—Ä —Ç—Ä–µ–±—É–µ—Ç interaction)');
                            }
                        });
                    }
                    break;
                    
                case 'pause':
                    // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: Pause –≤—Å–µ–≥–¥–∞ –±–µ–∑–æ–ø–∞—Å–µ–Ω
                    if (typeof data.time === 'number') {
                        video.currentTime = data.time;
                    }
                    video.pause();
                    console.log(`‚è∏Ô∏è –í–∏–¥–µ–æ –Ω–∞ paused, –≤—Ä–µ–º—è: ${video.currentTime.toFixed(2)}s`);
                    break;
                    
                case 'seek':
                    // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: Seek —Ç—Ä–µ–±—É–µ—Ç –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –≤–∏–¥–µ–æ
                    if (typeof data.time === 'number') {
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—Ä–µ–º—è –≤ –≤–∞–ª–∏–¥–Ω—ã—Ö –≥—Ä–∞–Ω–∏—Ü–∞—Ö
                        const validTime = Math.max(0, Math.min(data.time, video.duration || data.time));
                        video.currentTime = validTime;
                        console.log(`‚è™ Seek –Ω–∞ ${validTime.toFixed(2)}s –∏–∑ ${video.duration.toFixed(2)}s`);
                    }
                    break;
            }
        } catch (e) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã:', e);
            addSystemMessage(`‚ùå –û—à–∏–±–∫–∞: ${e.message}`);
        }
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ —á–µ—Ä–µ–∑ –∑–∞–¥–µ—Ä–∂–∫—É
        setTimeout(() => {
            state.ignoreNextSync = false;
            console.log('‚úÖ ignoreNextSync = false');
        }, 200);
    };
    
    // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ï—Å–ª–∏ –≤–∏–¥–µ–æ –µ—â–µ –Ω–µ –≥–æ—Ç–æ–≤–æ - –∂–¥–µ–º
    if (!isVideoReady()) {
        console.log(`‚è≥ –û–∂–∏–¥–∞—é –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –≤–∏–¥–µ–æ (readyState=${video.readyState})...`);
        
        // –°–æ–∑–¥–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –û–î–ò–ù –†–ê–ó
        const onCanPlay = () => {
            console.log('üìπ –í–∏–¥–µ–æ –≥–æ—Ç–æ–≤–æ –∫ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—é');
            executeCommand();
            video.removeEventListener('canplay', onCanPlay);
        };
        
        const onLoadedMetadata = () => {
            console.log('üìπ –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –≤–∏–¥–µ–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã');
            video.removeEventListener('loadedmetadata', onLoadedMetadata);
        };
        
        video.addEventListener('canplay', onCanPlay, { once: true });
        video.addEventListener('loadedmetadata', onLoadedMetadata, { once: true });
        
        // –¢–∞–π–º–∞—É—Ç –∫–∞–∫ –∑–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç - –≤—ã–ø–æ–ª–Ω—è–µ–º –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —á–µ—Ä–µ–∑ 5 —Å–µ–∫
        setTimeout(() => {
            console.log('‚è≤Ô∏è –¢–∞–π–º–∞—É—Ç –æ–∂–∏–¥–∞–Ω–∏—è - –≤—ã–ø–æ–ª–Ω—è—é –∫–æ–º–∞–Ω–¥—É –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ');
            video.removeEventListener('canplay', onCanPlay);
            executeCommand();
        }, 5000);
    } else {
        // –í–∏–¥–µ–æ –≥–æ—Ç–æ–≤–æ - –≤—ã–ø–æ–ª–Ω—è–µ–º —Å—Ä–∞–∑—É
        executeCommand();
    }
}
        function checkAndCorrectSync(data) {
            const video = elements.nativeVideo;
            if (!video || !state.currentVideoData || state.currentVideoData.type !== 'direct') return;
            
            const diff = Math.abs(video.currentTime - data.expectedTime);
            if (diff > 2) { // –î–æ–ø—É—Å–∫ 2 —Å–µ–∫—É–Ω–¥—ã
                console.log(`‚ö†Ô∏è –†–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω ${diff.toFixed(1)}s, –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É—é`);
                gentleSync(data.expectedTime);
            }
        }

        function gentleSync(targetTime) {
    const video = elements.nativeVideo;
    if (!video) return;
    
    // –ó–∞—â–∏—Ç–∞ –æ—Ç –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
    if (typeof targetTime !== 'number' || isNaN(targetTime) || targetTime < 0) {
        console.log('‚ö†Ô∏è –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –≤—Ä–µ–º—è –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:', targetTime);
        return;
    }
    
    // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é –≤–∏–¥–µ–æ
    if (video.duration && targetTime > video.duration) {
        targetTime = video.duration - 0.5;
    }
    
    console.log(`üéØ –ú—è–≥–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –Ω–∞ ${targetTime.toFixed(2)}—Å`);
    
    state.ignoreNextSync = true;
    
    // –ï—Å–ª–∏ —Ä–∞–∑–Ω–∏—Ü–∞ –±–æ–ª—å—à–∞—è, –¥–µ–ª–∞–µ–º –ø–ª–∞–≤–Ω–æ, –∏–Ω–∞—á–µ —Ä–µ–∑–∫–æ
    const currentTime = video.currentTime;
    const diff = Math.abs(currentTime - targetTime);
    
    if (diff > 5) {
        // –ë–æ–ª—å—à–∞—è —Ä–∞–∑–Ω–∏—Ü–∞ - –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–º–∞—Ç—ã–≤–∞–µ–º
        video.currentTime = targetTime;
        setTimeout(() => {
            state.ignoreNextSync = false;
        }, 200);
    } else {
        // –ú–∞–ª–µ–Ω—å–∫–∞—è —Ä–∞–∑–Ω–∏—Ü–∞ - –º–æ–∂–Ω–æ –º—è–≥–∫–æ –ø–æ–¥–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
        video.currentTime = targetTime;
        setTimeout(() => {
            state.ignoreNextSync = false;
        }, 150);
    }
}

        // ==================== –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –ö–ù–û–ü–û–ö ====================
        elements.createRoomBtn.addEventListener('click', () => {
            createRoom();
        });

        elements.joinRoomBtn.addEventListener('click', () => {
            const roomId = elements.roomIdInput.value.trim();
            if (roomId) {
                joinRoom(roomId);
            } else {
                alert('–í–≤–µ–¥–∏—Ç–µ ID –∫–æ–º–Ω–∞—Ç—ã');
            }
        });

        elements.leaveRoomBtn.addEventListener('click', () => {
            leaveRoom();
        });

        elements.copyRoomIdBtn.addEventListener('click', () => {
            navigator.clipboard.writeText(elements.currentRoomId.textContent).then(() => {
                alert('ID —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!');
            });
        });

        elements.loadUrlBtn.addEventListener('click', () => {
            loadVideo(elements.urlInput.value.trim());
        });

        elements.urlInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') elements.loadUrlBtn.click();
        });

        elements.syncNowBtn.addEventListener('click', () => {
            if (state.isLeader) {
                socket.emit('request-sync', { clientTime: Date.now() });
            }
            showSyncStatus(true);
        });

        elements.sendMessageBtn.addEventListener('click', () => {
            const text = elements.chatInput.value.trim();
            if (text) {
                socket.emit('send-chat-message', { message: text });
                addChatMessage(state.username, text, true);
                elements.chatInput.value = '';
            }
        });

        elements.chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') elements.sendMessageBtn.click();
        });

        // ==================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ====================
        updateConnectionStatus(false);
        addSystemMessage('üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ CINEMATE v2.0!');
        addSystemMessage('üé¨ –°–æ–∑–¥–∞–π—Ç–µ –∫–æ–º–Ω–∞—Ç—É –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ ID —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π');

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∏–∫–∞ –≤ –ø–æ–ª–µ –∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
        elements.nicknameInput.value = state.username;
        elements.changeNickBtn.addEventListener('click', () => {
            const newNick = elements.nicknameInput.value.trim();
            if (!newNick) return alert('–ù–∏–∫ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º');
            const old = state.username;
            state.username = newNick;
            socket.emit('change-username', { newUsername: newNick });
            addSystemMessage(`‚úèÔ∏è –í—ã —Å–º–µ–Ω–∏–ª–∏ –Ω–∏–∫: ${old} ‚Üí ${newNick}`);
        });
        elements.nicknameInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') elements.changeNickBtn.click();
        });

        window.addEventListener('beforeunload', () => {
            if (state.roomId) {
                leaveRoom();
            }
        });
    </script>
</body>
</html>
